{% extends 'base.html.twig' %}

{% block title %}{{prod.name}} , {{prod.catId.name}}  | Personnalisation de produit{% endblock %}

{% block stylesheets %}
        <style>
            .stepwizard-step p {
                margin-top: 0px;
                color:#666;
            }
            .stepwizard-row {
                display: table-row;
            }
            .stepwizard {
                display: table;
                width: 100%;
                position: relative;
            }
            .stepwizard-step button[disabled] {
                /*opacity: 1 !important;
                filter: alpha(opacity=100) !important;*/
            }
            .stepwizard .btn.disabled, .stepwizard .btn[disabled], .stepwizard fieldset[disabled] .btn {
                opacity:1 !important;
                color:#bbb;
            }
            .stepwizard-row:before {
                top: 14px;
                bottom: 0;
                position: absolute;
                content:" ";
                width: 100%;
                height: 1px;
                background-color: #ccc;
                z-index: 0;
            }
            .stepwizard-step {
                display: table-cell;
                text-align: center;
                position: relative;
            }
            .btn-circle {
                width: 30px;
                height: 30px;
                text-align: center;
                padding: 6px 0;
                font-size: 12px;
                line-height: 1.428571429;
                border-radius: 15px;
            }

            .border-choice{
                border: 2px solid black !important;
            }

            .select-bg{
                background: #fff;
            }


            .search-bg{
               background: #fff url('/images/pico/pp-icon-search.png') no-repeat calc(100% - 10px) center;
            }

            .download-bg{
                background: #fff url('/images/pico/pp-icon-download.png') no-repeat calc(100% - 10px) center;
            }

            .perso-etape-container {
                text-align: center;
                background: #f7f7f7;
                min-height: 200px;
                border-radius: 10px;
                margin-bottom: 20px;
                display: inline-block;
                width: 100%;
                box-sizing: border-box;
                padding: 15px;
                position: relative;
                z-index: 1;
            }

            .text-orientation-vartical{
                writing-mode: vertical-rl;
                text-orientation: mixed;
                font-family: 'Helvetica Neue Lt',Helvetica,Arial,sans-serif;
                width: 20px;
            }

            .vertical-label{
                border-radius: 0 5px 5px 0;
                color: white;
            }

            .action.primary {
                background-image: none;
                background: #3b586d;
                border: 1px solid #3b586d;
                color: #fff;
                cursor: pointer;
                font-family: 'Helvetica Neue Lt',Helvetica,Arial,sans-serif;
                font-weight: 700;
                padding: 7px 15px;
                font-size: 1.4rem;
                box-sizing: border-box;
            }

            .photo-control{
                background: #ffffff;
                display: inline-block;
                border: 2px solid #d1d7db;
                border-radius: 5px;
                padding: 5px;
                box-sizing: border-box;
                margin: 0;
            }

            .action-primary {
                background-image: none;
                background: #3b586d;
                border: 1px solid #3b586d;
                color: #fff;
                cursor: pointer;
                display: inline-block;
                font-family: 'Helvetica Neue Lt',Helvetica,Arial,sans-serif;
                font-weight: 700;
                padding: 7px 15px;
                font-size: 1.2rem;
                box-sizing: border-box;
                vertical-align: middle;
            }

        </style>  
{% endblock %}

{% block body %}
{% set preload = [] %}
<div class="container-fluid">
  <div class="row">
        <div class="col-12 ui steps">
                <div class="active step" data-target="#step-1">
                    <span class="btn btn-success btn-circle">1</span>
                    <div class="content">
                    <div class="title">Granite</div>
                    </div>
                </div>
                <div class="step disabled" data-target="#step-2">
                   <span class="btn btn-default btn-circle disabled">2</span>
                    <div class="content">
                    <div class="title">{{prod.subCatId.labelCustomStep ? prod.subCatId.labelCustomStep : 'Fixation' }}</div>
                    </div>
                </div>
                <div class="step disabled" data-target="#step-3">
                    <span class="btn btn-default btn-circle disabled">3</span>
                    <div class="content">
                    <div class="title">Motifs</div>
                    </div>
                </div>
                <div class="step disabled" data-target="#step-4">
                    <span class="btn btn-default btn-circle disabled">4</span>
                    <div class="content">
                    <div class="title">Textes</div>
                    </div>
                </div>
                {% if prod.subCatId.needPhotoStep %}
                    <div class="step disabled" data-target="#step-5">
                        <span class="btn btn-default btn-circle disabled">5</span>
                        <div class="content">
                        <div class="title">Photo</div>
                        </div>
                    </div>
                {% endif %}
                
                <div class="step disabled" data-target="{{prod.subCatId.needPhotoStep ? '#step-6' : '#step-5'}}">
                    <span class="btn btn-default btn-circle disabled">6</span>
                    <div class="content">
                    <div class="title">Résumé</div>
                    </div>
                </div>
            </div>
        </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row justify-content-start">
        <div id="frfu-previous-step" class="m-3 d-none">
            <span class="text-secondary text-underline">Etape Précédente</span>
        </div>
        <div div id="frfu-next-step" class="m-3 d-none">
            <span class="text-secondary text-underline">Etape Suivante</span>
        </div>
  </div>
</div>

    {% set ispro = false %}
    {% set id_photogravure = null %}
    {% set id_photogravure_fixation = null %}
    {% if app.user %}
    {% if app.user.type %}
        {% if app.user.type.id == 2 %}
            {% set ispro = true %}
        {% endif %}
    {% endif %}
    {% endif %}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="row">
            <div class="col-lg-6 col-md-12 border-right">
                <canvas id="frfu-content-canvas" class="upper-canvas canvas" width="500" height="500" style="position: absolute; width: 500px; height: 500px; left: 0px; top: 0px; user-select: none; cursor: default;"></canvas>
                
                {% set ini_price = prod.cprice %}
                {% set ini_ptailored = prod.priceTailored %}
                {% if app.user %}
                {% if app.user.type %}
                    {% if app.user.type.id == 2 %}
                        {% set ini_price = prod.pricepro %}
                        {% set ini_ptailored = prod.priceproTailored %}
                    {% endif %}
                {% endif %}
                {% endif %}
                <div class="row">
                    <div class="col-lg-8 col-md-10 ml-auto mr-auto rounded bg-light border m-2">
                        <div class="row">
                            <div class="col-12">
                                <p>Livraison d'ici le <span id="frfu-order-now-date"></span>
                                    Si vous commandez avant aujourd'hui 11h
                                    </p>
                            </div>
                            <div class="col-12 d-flex justify-content-center">
                                <span class="frfu-custom-total-price h3 text-sencondary">{{ini_price}}</span><span class="font-weight-bold"> €</span>
                            </div>
                        </div>
                    </div>
                    <div id="frfu-pl-custom-details" class="col-lg-8 col-md-10 ml-auto mr-auto m-2">

                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-12 col-sm-12">
            <div class="row">
            <div class="col-12 setup-content" id="step-1">
                <div class="row m-2">
                    <div class="col-10 perso-etape-container">
                        <div class="row m-2">
                            {% for granit in prod.galleries %}
                                {% set photo_granit = link_image(granit.granit.photo) %}
                                {% set preload = preload|merge([photo_granit, '/'~link_image(granit.photo)]) %}
                                <div class="col-md-4 col-6 border">
                                    {% set ini_gprice = granit.price %}
                                    {% if app.user %}
                                        {% if app.user.type %}
                                            {% if app.user.type.id == 2 %}
                                                {% set ini_gprice = granit.pricepro %}
                                            {% endif %}

                                        {% endif %}
                                    {% endif %}
                                    <img class="col-12 img-granit" {{granit.granit.isGravure ? 'data-gravure="1"' : ''}} src="{{"/"~photo_granit}}" data-id="{{granit.granit.id}}" data-gallery-id="{{granit.id}}" data-price="{{ini_gprice}}" data-label="Granite" data-url="{{'/'~link_image(granit.photo)}}">
                                    <div class="w-100 d-flex justify-content-center"><span></span>{{granit.granit.name}}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <span class="text-orientation-vartical mt-3"><span class="p-2 h-auto bg-dg vertical-label">Granites Disponibles</span></span>
                </div>
                <div class="row m-2">
                    <div class="col-10 perso-etape-container">
                        <div class="row m-2">
                            {% for granit in prod.galleriesThreeDay %}
                                {% set photo_granit = link_image(granit.granit.photo) %}
                                {% set preload = preload|merge([photo_granit, '/'~link_image(granit.photo)]) %}
                                <div class="col-md-4 col-6 border">
                                    {% set ini_gprice = granit.price %}
                                    {% if app.user %}
                                        {% if app.user.type %}
                                            {% if app.user.type.id == 2 %}
                                                {% set ini_gprice = granit.pricepro %}
                                            {% endif %}

                                        {% endif %}
                                    {% endif %}
                                    <img class="col-12 img-granit" {{granit.granit.isGravure ? 'data-gravure="1"' : ''}} src="{{"/"~photo_granit}}" data-id="{{granit.granit.id}}" data-gallery-id="{{granit.id}}" data-price="{{ini_gprice}}" data-label="Granite" data-url="{{'/'~link_image(granit.photo)}}">
                                    <div class="w-100 d-flex justify-content-center"><span></span>{{granit.granit.name}}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <span class="text-orientation-vartical mt-3"><span class="p-2 h-auto bg-dg vertical-label">Disponible en 72h</span></span>
                </div>
                <div class="row m-2">
                    <div class="col-10 perso-etape-container">
                        <div class="row m-2">
                            {% for granit in prod.galleriesTailored %}
                                {% set photo_granit = link_image(granit.granit.photo) %}
                                {% set preload = preload|merge([photo_granit, '/'~link_image(granit.photo)]) %}
                                <div class="col-md-4 col-6 border">
                                    {% set ini_gprice = granit.price %}
                                    {% if app.user %}
                                        {% if app.user.type %}
                                            {% if app.user.type.id == 2 %}
                                                {% set ini_gprice = granit.pricepro %}
                                            {% endif %}

                                        {% endif %}
                                    {% endif %}
                                    <img class="col-12 img-granit" {{granit.granit.isGravure ? 'data-gravure="1"' : ''}} src="{{"/"~photo_granit}}" data-id="{{granit.granit.id}}" data-gallery-id="{{granit.id}}" data-price="{{ini_gprice}}" data-label="Granite" data-url="{{'/'~link_image(granit.photo)}}">
                                    <div class="w-100 d-flex justify-content-center"><span></span>{{granit.granit.name}}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    <span class="text-orientation-vartical mt-3"><span class="p-2 h-auto bg-dg vertical-label">Granites sur mesures</span></span>
                </div>
                <div class="row w-100 p-2 d-flex justify-content-center">
                    <div id="granit-msg" class="text-danger d-none">Veuillez choisir un granite</div>
                    <div>
                    <button type="button" data-msg="#granit-msg" class="btn action-primary next-step" data-id="#order_custom_gallery" data-next="#step-2"><span class="text-bold">Suivant <i class="fas fa-arrow-right"></i></span></button>
                    </div>
                    
                </div>
            </div>
            <div class="col-12 setup-content" id="step-2">
                <div class="row w-100 p-2 d-flex justify-content-center">
                    <div id="stele-msg" class="text-danger p-2 d-none border-danger">{{prod.subCatId.needSteleFixation == 1 ? 'Veuillez choisir un composant' : 'Veuillez choisir une fixation' }}</div>
                </div>
                <div class="row">
                    <div class="col-10 perso-etape-container">
                        <div id="component-select-div" class="row m-2">
                            <label>Composants</label>
                            <select id="component-select" class="form-control">
                                <option value="">Selectionner un composant</option>
                                {% for component in components %}
                                    <option value="{{component.id}}" data-name="{{component.name}}">{{component.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="row m-2">
                            {% for gallery in prod.galleries %}
                                
                                {% for fix in decode_meta(gallery.metaData) %}
                                    {% if fix.id is defined %}
                                        {% set fixation = find_one_by('App\\Entity\\Fixation', {'id' : fix.id}) %}
                                        {% if fixation %}
                                            {% set photo = link_image(fixation.icon) %}
                                            {% set preload = preload|merge([fix.file]) %}
                                            <div class="col-md-4 col-6 border">
                                                <img class="col-12 img_fixation" src="{{"/"~photo}}" data-gallery-id="{{gallery.id}}" data-id="{{fixation.id}}" data-url="{{fix.file}}">
                                                <span class="p-2">{{fixation.name}}</span>
                                            </div>
                                        {% endif %}
                                    {% endif %}  
                                {% endfor %}
                            {% endfor %}

                            {% for gallery in prod.galleriesTailored %}
                                {% for fix in decode_meta(gallery.metaData) %}
                                    {% if fix.id is defined %}
                                        {% set fixation = find_one_by('App\\Entity\\Fixation', {'id' : fix.id}) %}
                                        {% if fixation %}
                                            {% set photo = link_image(fixation.icon) %}
                                            {% set preload = preload|merge([fix.file]) %}
                                            <div class="col-md-4 col-6 border">
                                                <img class="col-12 img_fixation" src="{{"/"~photo}}" data-gallery-id="{{gallery.id}}" data-id="{{fixation.id}}" data-url="{{fix.file}}">
                                                <span class="p-2">{{fixation.name}}</span>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}

                            {% for gallery in prod.galleriesThreeDay %}
                                {% for fix in decode_meta(gallery.metaData) %}
                                    {% if fix.id is defined %}
                                        {% set fixation = find_one_by('App\\Entity\\Fixation', {'id' : fix.id}) %}
                                        {% if fixation %}
                                            {% set photo = link_image(fixation.icon) %}
                                            {% set preload = preload|merge([fix.file]) %}
                                            <div class="col-md-4 col-6 border">
                                                <img class="col-12 img_fixation" src="{{"/"~photo}}" data-gallery-id="{{gallery.id}}" data-id="{{fixation.id}}" data-url="{{fix.file}}">
                                                <span class="p-2">{{fixation.name}}</span>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                    <span class="text-orientation-vartical mt-3"><span class="p-2 h-auto bg-dg vertical-label">Support de plaque</span></span>
                </div>
                <div class="row w-100 p-2 d-flex justify-content-center">
                    <div>
                    <button type="button" data-msg="#stele-msg" class="btn action-primary next-step" data-id="{{prod.subCatId.needSteleFixation == 1 ? '#order_custom_component' : '#order_custom_fixation' }}" data-other-id="" data-next="#step-3"><span class="text-bold">Suivant <i class="fas fa-arrow-right"></i></span></button>
                    </div>
                    
                </div>
            </div>

            <div class="col-12 setup-content" id="step-3">
                    

                <div class="row mt-2">
                    <div class="col-10 perso-etape-container">
                        <div class="row m-2">
                            <select id="frfu-select-field-motif" class="col-12 form-control select-bg" name="frfu-select-field-motif">
                                <option class="">Selectionner un motif</option>
                                {% for motif in motifs %}
                                <option value="{{motif.id}}" data-id="{{'#motif-selected-'~motif.id}}" data-url="{{url('motif-gallery', {'id' : motif.id})}}" data-motif-id="{{motif.id}}">{{motif.name}}</option>
                                {% endfor %}
                            </select>
                            <input id="frfu-search-field-motif" placeholder="Rechercher un motif..." type="search" class="col-12 form-control search-bg mt-2" name="frfu-search-field-motif">
                            <div class="col-12">
                                <div id="motif-select-load" class="row">
                                </div> 
                            </div> 
                            <div class="col-12">
                                <div id="frfu-motif-selected" class="row"></div>
                            </div>
                        </div>
                    </div> 
                    <span class="text-orientation-vartical mt-3"><span class="p-2 h-auto bg-dg vertical-label">Motifs du catalogue</span></span>
                </div>

                <div class="row mt-2 mb-2">
                    <div class="col-10 perso-etape-container">
                        <div class="row m-2">
                            <div class="col-12">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" id="inputGroupFileAddon01"><i class="fas fa-file-upload"></i></span>
                                    </div>
                                    <div class="custom-file">
                                        <input type="file" class="custom-file-input" id="frfu-upload-custom-img" name="custom-img" accept=".png, .jpg, .jpeg" data-upload-url="{{url('product-upload-custom-img')}}"
                                        data-price="{{getConfig('custom_motif_img').value}}" aria-describedby="inputGroupFileAddon01">
                                        <label class="custom-file-label" for="inputGroupFile01">Télécharger votre fichier(jpg,png)</label>
                                    </div>
                                </div>
                                <img id="frfu-custom-img" class="ml-auto mr-auto" src="" height="100">
                            </div>
                            <div id="frfu-motif-uploaded" class="col-12 bg-light">
                            </div>
                        </div>
                    </div>
                    <span class="text-orientation-vartical mt-3"><span class="p-2 h-auto bg-dg vertical-label">Motifs Personnalisée</span></span>
                </div>


                <div class="row w-100 p-2 d-flex justify-content-center">
                    <div id="granit-msg" class="text-danger d-none">Veuillez choisir un granite</div>
                    <div>
                    <button type="button" class="btn action-primary next-step" data-id="#stele_choose_text" data-next="#step-4"><span class="text-bold">Suivant <i class="fas fa-arrow-right"></i></span></button>
                    </div>
                    
                </div>


                
            </div>
            <div class="col-12 setup-content" id="step-4">
                <div class="col-12 text-center">
                    Choississez la typographie du texte à graver
                </div>
                {#<div class="row">
                    {% for text in texts %}
                        <div class="col-6 border text-center frfu-custom-font-family" style="{{text.fontFamily}}">
                            {{text.name}}
                        </div>
                    {% endfor %}
                </div>

                <div class="col-12 text-center">
                    Choississez la couleur  du texte à graver
                </div>
                <div class="row">
                    {% for color in colors %}
                        <div class="col-6 border d-flex justify-content-center frfu-custom-color" style="{{'background-color: '~color.value~';'}}">
                            {% if color.value == 'black' %} 
                                <span class="text-white">{{color.name}}</span>
                                {% else %}
                                <span class="text-dark">{{color.name}}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>#}
                <div class="row mt-2">
                    <div id="frfu-add-remove-custom-text" class="col-12">
                        
                    </div>
                    <div class="col-12 d-flex justify-content-end" style="margin-top: -30px;">
                        <input id="frfu-current-number-custom-text-field" type="hidden" value="0">
                        <span id="frfu-add-custom-text-element" data-font="{{json_object(texts)|json_encode()}}" data-color="{{json_object(colors)|json_encode()}}" class="btn btn-sm btn-success"><i class="fas fa-plus"></i></span>
                    </div>  
                </div>

                <div class="row mt-2">
                    <div id="frfu-add-remove-custom-text-reference" class="col-12">
                        
                    </div>
                    <div class="col-12 d-flex justify-content-end" style="margin-top: -30px;">
                        <input id="frfu-current-number-custom-text-field-reference" type="hidden" value="0">
                        <span id="frfu-add-custom-text-element-reference" data-font="{{json_object(texts)|json_encode()}}" data-color="{{json_object(colors)|json_encode()}}" class="btn btn-sm btn-success"><i class="fas fa-plus"></i></span>
                    </div>  
                </div>
               <button id="" type="button" class="btn action-primary next-step" data-id="#stele_choose_text" data-next="#step-5"><span class="text-bold">Suivant <i class="fas fa-arrow-right"></i></span></button>
                
            </div> 

            <div class="col-12 setup-content {{prod.subCatId.needPhotoStep ? '' : 'd-none'}}" id="{{prod.subCatId.needPhotoStep ? 'step-5' : ''}}">
                <div id="frfu-add-cadre-block" class="row">

                </div>
                <div class="row">
                    <div class="col-12 d-flex justify-content-end position-absolute z-index-100" style="margin-top: -30px; margin-right: -15px;">
                        <span id="frfu-add-cadre-action" class="btn btn-success"><i class="fas fa-plus"></i></span>
                    </div>
                </div>

                <div id="frfu-add-cadre-gravure-msg-block" class="row m-2 justify-content-center">
                    <div class="col-11 p-2 mt-2 mb-2"  style="background-color: gray; border-radius: 15px;">
                        <div class="row">
                            <div class="col-12">
                                <p class="text-white p-1 text-align-center">La photo gravure est uniquement possible sur un support en Noir Fin.</p>
                                <p class="text-white text-bold p-1 text-align-center">Souhaitez vous modifier la couleur de la plaque ?</p>
                            </div>
                            <div class="col-12 d-flex justify-content-center">
                                <span id="frfu-add-cadre-gravure-msg-accept" class="p-2 rounded bg-white mt-2" style="height: 40px; width: 70px;"><span>Oui</span><span style="height: 32px; width: 32px; padding: 2px; border-radius: 50%; background-color: darkslategray;"><i class="fas fa-check text-white"></i></span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="frfu-add-cadre-gravure-block" class="row d-none">

                </div>
                <div class="row">
                    <div class="col-12 d-flex justify-content-end position-absolute z-index-100" style="margin-top: -30px; margin-right: -15px;">
                        <span id="frfu-add-gravure-action" class="btn btn-success  d-none"><i class="fas fa-plus"></i></span>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <span id="pass-step-6" class="btn action-primary next-step" data-next="#step-6">Suivant</span>
                </div>
            </div> 
            <div class="col-12 setup-content" id="{{prod.subCatId.needPhotoStep ? 'step-6' : 'step-5'}}">
                <div class="row">
                    <div id="frfu-resume" class="col-11 ml-auto mr-auto bg-light" style="border-radius: 20px;">
                    
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8 col-xs-10 ml-auto mr-auto rounded bg-light border m-2">
                        <div class="row">
                            <div class="col-12">
                                <p>Livraison d'ici le <span id="frfu-order-now-date"></span>
                                    Si vous commandez avant aujourd'hui 11h
                                    </p>
                            </div>
                            <div class="col-12 d-flex justify-content-center">
                                <span class="frfu-custom-total-price h3 text-sencondary"></span><span class="h3 text-sencondary">€</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center">
                    <form id="devis-form" action="{{url('product-before-customize-before', {'id' : prod.id})}}" method="POST">
                        <div class="d-none">
                        {{ form_widget(form._token) }}
                        {{ form_widget(form.qty) }}
                        {{ form_widget(form.userId) }}
                        {{ form_widget(form.gallery) }}
                        {{ form_widget(form.fixation) }}
                        {{ form_widget(form.productId) }}
                        {{ form_widget(form.isCustom) }}
                        {{ form_widget(form.component) }}
                        {{ form_widget(form.metaData) }}
                        {{ form_widget(form.invoice) }}
                        </div>
                    </form>
                    <span id="frfu-add-order-action" class="btn action-primary">Commander</span>
                </div>
            </div> 
            </div>
            </div>  
        </div>
         {#<input type="hidden" id="photoplaque" value="{{'/'~link_image(prod.pho)}}">#}
         <input type="hidden" id="stele_choose_text" name="stele_choose_text" value="no-text">
         <input type="hidden" id="stele_choose_image" name="stele_choose_text" value="no-text">
        </div>
        </div>
       </div>
    </div>
    <div id="frfu-photo-product-to-customize" class="d-none"><img src=""></div>
</div>
<div id="frfu-preload-all-img" class="d-none" data-preload="{{preload|json_encode()}}"></div>
<img id="frfu-preload-transparent-img" src="https://funerairefrance.com/transparent.png" class="d-none">

{% endblock %}

{% block javascripts %}
    {% include 'includes/resize.html.twig' %}
    <script>
        $(document).ready(function () {
           

            var navListItems = $('div.steps .step'),
                currentStep = 1,
                allWells = $('.setup-content'),
                canvas = new fabric.Canvas('frfu-content-canvas'),
                 canvas_fix = new fabric.Canvas('frfu-canvas'),
                applyButton = $('.frfu-add-custom-text-button'),
                addCustomTextElement = $('#frfu-add-custom-text-element'),
                toCustomize = $('.frfu-photo-product-to-customize'),
                img_granit = $('.img-granit'),
                img_fixation = $('.img_fixation'),
                motifsMd = [],
                components = [];
                patterns = [],
                imgs = [],
                allNextBtn = $('.next-step'),
                metaData = {
                    img : {

                    },
                    text : {

                    }
                };
                var processing = false;

            allWells.hide();

            function putDate(){
                $('#frfu-order-now-date').text("{{day_month()}}");
            }

            putDate();

            function switchStepElement(){
                if($(window).width() <= 1025){
                    if(currentStep > 1){
                        if($('#frfu-previous-step').hasClass('d-none')){
                            $('#frfu-previous-step').removeClass('d-none');
                        }

                        if($('#frfu-next-step').hasClass('d-none')){
                            $('#frfu-next-step').removeClass('d-none');
                        }
                        
                    }
                }
            }



            function buildInsertMetaData(){
                //var json = JSON.stringify(canvas);
                var objs = canvas._objects;
                var lenObjs = objs.length;
                var metaData = canvas.toObject();
                for(var i = 0; i < lenObjs; i++){
                    var obj = objs[i];
                    metaData.objects[i].dataprice = obj.dataprice;
                    metaData.objects[i].frfuNameObject = obj.frfuNameObject;
                    metaData.objects[i].frfuLabelObject = obj.frfuLabelObject;
                    metaData.objects[i].uniqId = obj.uniqId;
                }
                var json = JSON.stringify(metaData);
                //console.log(json);
                $('#order_custom_metaData').val(json);
                console.log($('#order_custom_metaData').val());
                console.log($('#order_custom_productId').val());
                console.log($('#order_custom_gallery').val());
                console.log($('#order_custom_fixation').val());
                var url = canvas.toDataURL('image/png');
                $('#order_custom_invoice').val(url);

            }

            function getMd(uniqId){
                var i = 0;
                var item = null;
                var found = false;
                objs = motifsMd;
                objs.forEach(obj => {
                    //console.log(obj[0]);
                    if(obj[0].uniqId == uniqId){
                        item = i;
                        found =true;

                    }
                    i++;
                });

                if(found){
                    return item;
                }else{
                    return false;
                }
            }

            function getPattern(uniqId){
                var i = 0;
                var item = null;
                var found = false;
                objs = patterns;
                objs.forEach(obj => {
                    //console.log(obj[0]);
                    if(obj[0].uniqId == uniqId){
                        item = i;
                        found =true;

                    }
                    i++;
                });

                if(found){
                    return item;
                }else{
                    return false;
                }
            }

            function priceAndItems(){
                var objects = canvas._objects;
                var total = 0;
                var items = [];
                var len_objects = objects.length;
                //items.push({label: canvas.backgroundImage.frfuLabelObject, price: canvas.backgroundImage.dataprice})
                for(var i =0; i < len_objects; i++){
                    var object = objects[i];
                    if(object.dataprice){
                        total += Number(object.dataprice);
                        items.push({label: object.frfuLabelObject, price: object.dataprice})
                    }else{
                        items.push({label: object.frfuLabelObject, price: 0})
                    } 
                }
                
                $('.frfu-custom-total-price').text(total);
                $('#frfu-pl-custom-details').find('.frfu-pl-custom-details-item').remove();
                $('#frfu-resume').children().remove();
                console.log(items);
                var lenItems = items.length;
                 for(var j =0; j < lenItems; j++){
                     var bottom = j != lenItems - 1 ? 'border-bottom' : '';
                     var obj = items[j];
                    $('#frfu-pl-custom-details').append('<div class="frfu-pl-custom-details-item">\
                        <span class="mr-2 text-secondary">'+obj.label+'</span><span> .................... </span><span class="ml-2 text-secondary">'+obj.price+'</span><span class="text-secondary">€</span>\
                    </div>\
                    ');

                    $('#frfu-resume').append('<div class="col-12 p-2 '+bottom+'">\
                        <div class="row">\
                            <div class="col-md-6 col-sm-9 col-9 p-2">\
                                <span class="mr-2 text-dsg">'+obj.label+'</span>\
                            </div>\
                            <div class="col-md-6 col-sm-3 col-3 p-2">\
                                <span class="ml-2 font-weight-bold">'+obj.price+'</span><span class="font-weight-bold">€</span>\
                            </div>\
                        </div>\
                    </div>\
                    ');
                }
                console.log(canvas);
                

            }

            function uniqKey(){
                var random = Math.floor(Math.random() * 1000000); 
                var time = new Date().getTime();  
                return String(random)+String(time);
            }
            
            function elmentExists(uniqId){
                var i = 0;
                var item = null;
                var found = false;
                objs = canvas._objects;
                objs.forEach(obj => {
                    if(obj.uniqId == uniqId){
                        item = i;
                        found =true;

                    }
                    i++;
                });

                if(found){
                    return item;
                }else{
                    return false;
                }
                
            }

            function link_image(link){
                
                var lk = link.split('/public/')[1];
                return '/'+lk;
            }

            function generateGravureDiv(){
                {% set isPro = false %}
                {% if app.user %}
                {% if app.user.type %}
                    {% if app.user.type.id == 2 %}
                        {% set isPro = true %}
                    {% endif %}
                {% endif %}
                {% endif %}
                var cadres = {{json_object(find_by('App\\Entity\\Cadre', {'isGravure' : true}))|json_encode()|raw}};
                
                var ispro = {{isPro ? 1 : 0}};
                var uniqId = uniqKey();
                var select = '<select data-uniq="'+uniqId+'" id="frfu-gravure-'+uniqId+'" name="frfu-gravure-'+uniqId+'" class="form-control frfu-gravure">';
                var options = '<option value="">Selectionner la forme du cadre</option>';
                var endSelect = '</select>';

                json_cadres = JSON.parse(JSON.stringify(cadres));
                var len = json_cadres.length;
                var optionArray = [];
                for(var i = 0; i < len; i++) {
                    cadre = json_cadres[i];
                    var price = ispro == 1 ? cadre.price : cadre.pricepro;
                    optionArray.push('<option value="'+cadre.id+'" data-price="'+price+'" data-height="'+cadre.height+'" data-width="'+cadre.width+'" data-circle="'+cadre.isCircle+'" data-ovale="'+cadre.ovale+'" data-image="'+cadre.photo+'">'+cadre.name+'</option>');
                }
                
                var div =  '<div id="frfu-gravure-div-item-'+uniqId+'" class="col-11 bg-light mt-2 mb-2" style="border-radius: 15px;">\
                                <span class="text-orientation-vartical position-absolute mt-5" style="margin-left: 98%; z-index: -1;"><span class="p-2 h-auto bg-dg vertical-label">Photogravure</span></span>\
                                <div class="row m-3">\
                                    '+select+options+optionArray.join('')+endSelect+'\
                                </div>\
                                <div class="row m-3">\
                                    <div class="col-12 mb-2">\
                                        <input data-id="'+uniqId+'" id="frfu-field-photo-gravure-'+uniqId+'" placeholder="" name="frfu-field-photo-gravure-'+uniqId+'" class="download-bg frfu-field-photo-gravure d-none" type="file">\
                                    </div>\
                                    <div class="col-12 mb-2">\
                                        <button data-id="'+uniqId+'" type="button" class="action-primary frfu-gravure-photo-import"><span class="text-bold">Importer la photo</span></button>\
                                        <button data-id="'+uniqId+'" type="button" class="btn frfu-cadre-remove"><span class="text-bold text-danger">Supprimer</span></button>\
                                    </div>\
                                </div>\
                                <div class="row m-3  justify-content-around">\
                                    <div class="col-md-4 text-center">\
                                        <div class="row">\
                                            Position de la photo dans le cadre\
                                        </div>\
                                        <div class="d-flex justify-content-center">\
                                            <img class="img-fluid" src="/images/pico/pp-icon-photo-position.png">\
                                        </div>\
                                    </div>\
                                    <div class="col-md-8 bg-white border border-secondary photo-control">\
                                        <div class="row">\
                                            <div class="col-6">\
                                                <div class="row">\
                                                    <div class="col-md-1 col-sm-2 col-xs-2">\
                                                        <i data-id="'+uniqId+'" class="fas fa-arrow-left frfu-custom-photogravure-position-left"></i>\
                                                    </div>\
                                                    <div class="col-md-1 col-sm-2 col-xs-2">\
                                                        <i data-id="'+uniqId+'" class="fas fa-arrow-up d-block frfu-custom-photogravure-position-up"></i>\
                                                        <i data-id="'+uniqId+'" class="fas fa-arrow-down d-block frfu-custom-photogravure-position-down"></i>\
                                                    </div>\
                                                    <div class="col-md-1 col-sm-2 col-xs-2">\
                                                        <i data-id="'+uniqId+'" class="fas fa-arrow-right frfu-custom-photogravure-position-right"></i>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                            <div class="col-6">\
                                                <div class="d-flex justify-content-center">\
                                                    <span data-id="'+uniqId+'" class="mr-2 col-6 frfu-custom-photogravure-size-plus">A <i class="fas fa-plus"></i></span>\
                                                    <span data-id="'+uniqId+'" class="ml-2 frfu-custom-photogravure-size-minus">A <i class="fas fa-minus"></i></span>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>';
                $('#frfu-add-cadre-gravure-block').append(div);
            }

            function generatePhotoDiv(){
                {% set isPro = false %}
                {% if app.user %}
                {% if app.user.type %}
                    {% if app.user.type.id == 2 %}
                        {% set isPro = true %}
                    {% endif %}
                {% endif %}
                {% endif %}
                var cadres = {{json_object(find_by('App\\Entity\\Cadre', {'isGravure' : false}))|json_encode()|raw}};
                
                var ispro = {{isPro ? 1 : 0}};
                var uniqId = uniqKey();
                var select = '<select data-uniq="'+uniqId+'" id="frfu-cadre-'+uniqId+'" name="frfu-cadre-'+uniqId+'" class="form-control frfu-cadre">';
                var options = '<option value="">Selectionner la forme du cadre</option>';
                var endSelect = '</select>';

                json_cadres = JSON.parse(JSON.stringify(cadres));
                var len = json_cadres.length;
                var optionArray = [];
                for(var i = 0; i < len; i++) {
                    cadre = json_cadres[i];
                    var price = ispro == 1 ? cadre.price : cadre.pricepro;
                    optionArray.push('<option value="'+cadre.id+'" data-price="'+price+'" data-height="'+cadre.height+'" data-width="'+cadre.width+'" data-circle="'+cadre.isCircle+'" data-ovale="'+cadre.ovale+'" data-image="'+cadre.photo+'">'+cadre.name+'</option>');
                }
                
                var div = '<div id="frfu-photo-div-item-'+uniqId+'" class="col-11 bg-light mt-2 mb-2" style="border-radius: 15px;">\
                                <span class="text-orientation-vartical position-absolute mt-5" style="margin-left: 98%; z-index: -1;"><span class="p-2 h-auto bg-dg vertical-label">Photo porcelaine</span></span>\
                                <div class="row m-3">\
                                    '+select+options+optionArray.join('')+endSelect+'\
                                </div>\
                                <div class="row m-3">\
                                    <div class="col-12 mb-2">\
                                        <input data-id="'+uniqId+'" id="frfu-field-photo-cadre-'+uniqId+'" placeholder="" name="frfu-field-photo-cadre-'+uniqId+'" class="download-bg frfu-field-photo-cadre d-none" type="file">\
                                    </div>\
                                    <div class="col-12 mb-2">\
                                        <button data-id="'+uniqId+'" type="button" class="action-primary frfu-cadre-import"><span class="text-bold">Importer la photo</span></button>\
                                        <button data-id="'+uniqId+'" type="button" class="btn frfu-cadre-remove"><span class="text-bold text-danger">Supprimer</span></button>\                                    </div>\
                                    </div>\
                                <div class="row m-3  justify-content-around">\
                                    <div class="col-md-4 text-center">\
                                        <div class="row">\
                                            Position de la photo dans le cadre\
                                        </div>\
                                        <div class="d-flex justify-content-center">\
                                            <img class="img-fluid" src="/images/pico/pp-icon-photo-position.png">\
                                        </div>\
                                    </div>\
                                    <div class="col-md-8 bg-white border border-secondary photo-control">\
                                        <div class="row">\
                                            <div class="col-6">\
                                                <div class="row">\
                                                    <div class="col-md-1 col-sm-2 col-xs-2">\
                                                        <i data-id="'+uniqId+'" class="fas fa-arrow-left frfu-custom-photo-position-left"></i>\
                                                    </div>\
                                                    <div class="col-md-1 col-sm-2 col-xs-2">\
                                                        <i data-id="'+uniqId+'" class="fas fa-arrow-up d-block frfu-custom-photo-position-up"></i>\
                                                        <i data-id="'+uniqId+'" class="fas fa-arrow-down d-block frfu-custom-photo-position-down"></i>\
                                                    </div>\
                                                    <div class="col-md-1 col-sm-2 col-xs-2">\
                                                        <i data-id="'+uniqId+'" class="fas fa-arrow-right frfu-custom-photo-position-right"></i>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                            <div class="col-6">\
                                                <div class="d-flex justify-content-center">\
                                                    <span data-id="'+uniqId+'" class="mr-2 col-6 frfu-custom-photo-size-plus">A <i class="fas fa-plus"></i></span>\
                                                    <span data-id="'+uniqId+'" class="ml-2 frfu-custom-photo-size-minus">A <i class="fas fa-minus"></i></span>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>\
                                </div>\
                                <div class="row m-3">\
                                    <div class="col-md-4 text-center">\
                                        <div class="col-12">\
                                            Position de la photo dans le cadre\
                                        </div>\
                                        <div class="d-flex justify-content-center">\
                                            <img class="img-fluid" src="/images/pico/pp-icon-medaillon-options.png">\
                                        </div>\
                                    </div>\
                                    <div class="col-md-8 bg-white border border-secondary photo-control">\
                                        <div class="row">\
                                            <div class="col-12 d-flex justify-content-around">\
                                                <div>\
                                                    <div data-id="'+uniqId+'" class="bg-light frfu-cadre-border-none" style="height:40px; width: 40px; border-radius: 50%;">\
                                                        <img class="img-fluid" src="/images/pico/pp-icon-silhouette.png">\
                                                    </div>\
                                                    <div>\
                                                        Aucun contour\
                                                    </div>\
                                                </div>\
                                            <div>\
                                                <div data-id="'+uniqId+'" class="bg-light frfu-cadre-border-filet-or" style="height:40px; width: 40px; border-radius: 50%; border: 2px solid gold">\
                                                    <img class="img-fluid" src="/images/pico/pp-icon-silhouette.png">\
                                                </div>\
                                                <div>\
                                                    Filet Or\
                                                </div>\
                                            </div>\
                                            <div>\
                                                <div data-id="'+uniqId+'" class="bg-light frfu-cadre-border-bord-or" style="height:40px; width: 40px; border-radius: 50%; border: 4px solid gold">\
                                                    <img class="img-fluid" src="/images/pico/pp-icon-silhouette.png">\
                                                </div>\
                                                <div>\
                                                    Bord Or\
                                                </div>\
                                            </div>\
                                            <div>\
                                                <div data-id="'+uniqId+'" class="bg-light frfu-cadre-border-bord-blanc" style="height:40px; width: 40px; border-radius: 50%; border: 4px solid white">\
                                                    <img class="img-fluid" src="/images/pico/pp-icon-silhouette.png">\
                                                </div>\
                                                <div>\
                                                    Bord Blanc\
                                                </div>\
                                            </div>\
                                        </div>\
                                        <div class="col-12 d-flex justify-content-around">\
                                            <div>\
                                                <div data-id="'+uniqId+'" class="frfu-cadre-photo-filter-color" style="height:40px; width: 40px; border-radius: 50%; background-image: linear-gradient(-45deg, #09c 20%, #008000 25%, #ff0 50%, #ffa500 75%, #f00 80%);">\
                                                </div>\
                                                    <div>\
                                                        Couleur\
                                                    </div>\
                                                </div>\
                                            <div>\
                                                <div data-id="'+uniqId+'" class="frfu-cadre-photo-filter-white-black" style="height:40px; width: 40px; border-radius: 50%; background: linear-gradient(135deg, #000 0%, #000 51%, #fff 56%, #fff 100%);"></div>\
                                                <div>Blanc noir</div>\
                                            </div>\
                                            <div><div data-id="'+uniqId+'" class="frfu-cadre-photo-filter-sepia" style="height:40px; width: 40px; border-radius: 50%; background: linear-gradient(135deg, #963 0%, #963 51%, #fff 56%, #fff 100%);"></div><div></div>Sepia</div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                            ';
                $('#frfu-add-cadre-block').append(div);

            }

            $('#component-select').change(function(){
                var compId = $(this).val();
                if(compId !== ''){
                    var el = $('#order_custom_component option[value='+compId+']');
                    console.log(el);
                    el.attr('selected', true);
                    objs = canvas._objects;
                    lengthObjs = objs.length;
                    var i = 0;
                    var index = null;
                    var found = false;
                    objs.forEach(obj => {
                        if(obj.frfuNameObject == 'component'){
                            index = i;
                            found = true;
                        }
                        i++;
                    });

                    if(found){
                        var obj = canvas._objects[index];
                        obj.frfuLabelObject = $('#component-select option[value='+compId+']').attr('data-name');
                        canvas._objects[index] = obj;
                        canvas.requestRenderAll();
                        priceAndItems();
                    }
                    else{
                        var text = new fabric.Textbox('', {
                            width:250,
                            cursorColor :"blue",
                            top:10,
                            left:10,
                            editable: false,
                            dataprice: 0,
                            frfuLabelObject: $('#component-select option[value='+compId+']').attr('data-name'),
                            frfuNameObject: 'component'
                        });
                        canvas.add(text);
                        canvas.requestRenderAll();
                        priceAndItems();
                    }
                }
                
            });
                 
            $('.motif-selected').hide();
            $('#frfu-custom-img').hide();
            //canvas.backgroundColor = 'whitesmoke';
            var bgImg = new Image();
            bgImg.src = '/'+"{{link_image(prod.photo)}}";
            var coef = canvas.width/bgImg.width;

            canvas.setBackgroundImage(bgImg.src, canvas.renderAll.bind(canvas), {
                // should the image be resized to fit the container?
                width: canvas.width,
                height: canvas.height
            });
            $('#background-image-canvas').remove();

            $('#pass-step-6').click(function(){
                //var idInputToVerify = $(this).attr('data-id'),
                var next = 'div[data-target="'+$(this).attr('data-next')+'"]';

                $(next).find('.btn').attr('class', 'btn btn-success btn-circle');;
                $(next).addClass('active');
                $(next).removeClass('disabled');
                $(next).trigger('click');
            });

            $('body').delegate('.motif-image', 'click', function(){
                
                var price = Number($(this).attr('data-price'));
                var cprice = price + Number($('#frfu-custom-price-images').text());
                var price_total = Number($($('.frfu-custom-total-price')[0]).text()) + price;
                var black = $(this).attr('data-url-black');
                var white = $(this).attr('data-url-white');
                var gold = $(this).attr('data-url-gold');
                var pugImg = new Image();
                pugImg.onload = function (img) { 
                    var uniqId = uniqKey();
                    var pug = new fabric.Image(pugImg, {
                        angle: 45,
                        width: 500,
                        height: 500,
                        left: 50,
                        top: 70,
                        scaleX: .25,
                        scaleY: .25,
                        frfuLabelObject: 'Motif',
                        frfuNameObject: 'motif',
                        dataprice: price,
                        uniqId: uniqId
                    });
                    canvas.add(pug);
                    $("#frfu-motif-selected").append('<div class="col-12 p-2"><div class="row"><img height="40px" src="'+pugImg.src+'"> <span id="'+uniqId+'" class="text-dander frfu-motif-item-remove">Supprimer</span></div><div class="row"><div class="col-3 p-2"><span>Couleur du motif</span></div> <div class="col-9 p-2 d-flex justify-content-around"><div style="background-color: black; width: 40px; height: 40px; border-radius: 50%;" data-id="'+uniqId+'"  data-url="'+black+'" class="frfu-motif-item-color"></div> <div style="background-color: white; width: 40px; height: 40px; border-radius: 50%;" data-id="'+uniqId+'" data-url="'+white+'" class="frfu-motif-item-color"></div> <div style="background-color: yellow; width: 40px; height: 40px; border-radius: 50%;" data-id="'+uniqId+'" data-url="'+gold+'" class="frfu-motif-item-color"></div></div></div></div>')
                    priceAndItems();
                };
                pugImg.src = black;
                $('.motif-image').parent().removeClass('border-choice');
                $(this).parent().addClass('border-choice');
            });

            $('#frfu-select-field-motif').change(function(){
                var value = $(this).val();
                var option = $('#frfu-select-field-motif option[value='+value+']');
                var url = option.attr('data-url');
                $('#motif-select-load').children().remove();
                $('#motif-select-load').append('<img class="img-fluid ml-auto mr-auto mt-3 mb-3" src="/images/pico/ajax-loader.gif">');
                $.ajax({
                    url: url,
                    type: 'get',
                    success: function(res){
                        //console.log(res);
                        if(res.success === true){
                            var lenMotifs = res.motifs.length;
                            var toAppend = '';
                            for(var i = 0; i < lenMotifs; i++){
                                var motif = res.motifs[i];
                                var priceMotif = res.ispro ? motif.pricepro : morif.price;
                                var obj = JSON.parse(JSON.parse(motif.metaData));
                                
                                var black = obj.black;
                                var white = obj.white;
                                var gold = obj.gold;
                                console.log(obj);
                                toAppend = toAppend+'<div class="col-3 border"><img class="col-12 motif-image" data-url-black="'+black+'" data-url-white="'+white+'" data-url-gold="'+gold+'" src="'+link_image(motif.photo)+'" data-price="'+priceMotif+'"></div>';
                               
                            }
                            $('#motif-select-load').children().remove();
                            $('#motif-select-load').append(toAppend);
                        }
                    },
                    error: function(err){
                        console.log(err);
                    }
                });
                
            });

            $('#frfu-search-field-motif').keyup(function(){
                var value = $(this).val();
                //var option = $('#frfu-select-field-motif option[value='+value+']');
                //var url = option.attr('data-url');
                $('#motif-select-load').children().remove();
                $('#motif-select-load').append('<img class="img-fluid ml-auto mr-auto mt-3 mb-3" src="/images/pico/ajax-loader.gif">');
                $.ajax({
                    url: '/motif/search/'+value,
                    type: 'get',
                    success: function(res){
                        //console.log(res);
                        if(res.success === true){
                            var lenMotifs = res.motifs.length;
                            var toAppend = '';
                            for(var i = 0; i < lenMotifs; i++){
                                var motif = res.motifs[i];
                                var priceMotif = res.ispro ? motif.pricepro : morif.price;
                                var obj = JSON.parse(JSON.parse(motif.metaData));
                                
                                var black = obj.black;
                                var white = obj.white;
                                var gold = obj.gold;
                                console.log(obj);
                                toAppend = toAppend+'<div class="col-3 border"><img class="col-12 motif-image" data-url-black="'+black+'" data-url-white="'+white+'" data-url-gold="'+gold+'" src="'+link_image(motif.photo)+'" data-price="'+priceMotif+'"></div>';
                                 
                            }
                            $('#motif-select-load').children().remove();
                            $('#motif-select-load').append(toAppend);
                        }
                    },
                    error: function(err){
                        console.log(err);
                    }
                });
                
            });

            $('body').delegate('.frfu-custom-text-font-family', 'change', function(){
                var uniqId = $(this).attr('data-id');
                var value = $(this).val();
                var index = elmentExists(uniqId);
                if(index !== false){
                    canvas._objects[index].set("fontFamily", $('.frfu-custom-text-font-family[data-id='+uniqId+'] option:selected').css('font-family'));
                    canvas.requestRenderAll();
                }
                
            });

            $('body').delegate('.frfu-custom-font-color', 'click', function(){
                var uniqId = $(this).attr('data-id');
                var index = elmentExists(uniqId);
                if(index !== false){
                    canvas._objects[index].setColor($(this).css('background-color'));
                    canvas.requestRenderAll();
                }
            });

            $('body').delegate('.frfu-custom-text-font-family-identity', 'change', function(){
                var uniqId = $(this).attr('data-id');
                var value = $(this).val();
                var index = elmentExists(uniqId);
                if(index !== false){
                    var len = canvas._objects[index]._objects.length;
                    for(var i = 0; i <len; i++){
                        canvas._objects[index]._objects[i].set("fontFamily", $('.frfu-custom-text-font-family-identity[data-id='+uniqId+'] option:selected').css('font-family'));
                    }
                    canvas.requestRenderAll();
                }
                
            });

            $('body').delegate('.frfu-custom-font-color-identity', 'click', function(){
                var uniqId = $(this).attr('data-id');
                var index = elmentExists(uniqId);
                if(index !== false){
                    var len = canvas._objects[index]._objects.length;
                    for(var i = 0; i <len; i++){
                        canvas._objects[index]._objects[i].setColor($(this).css('background-color'));
                    }
                    canvas.requestRenderAll();
                }
            });

            //canvas.css({'height' : toCustomize.height()+'px', 'width' : toCustomize.height()+'px'})
            navListItems.click(function (e) {
                e.preventDefault();
                console.log('caught again!!!');
                var $target = $($(this).attr('data-target')),
                    $item = $(this);

                if(currentStep === 1){
                    if(!$('#frfu-previous-step').hasClass('d-none')){
                        $('#frfu-previous-step').addClass('d-none');
                    }
                }
                    
                if (!$item.hasClass('disabled')) {
                    navListItems.removeClass('btn-success').addClass('btn-default');
                    $item.addClass('btn-success');
                    allWells.hide();
                    $target.show();
                    $target.find('input:eq(0)').focus();
                }
            });

           
            addCustomTextElement.click(function(e){
                
                var uniqId = uniqKey();
                var fonts = JSON.parse($(this).attr('data-font'));
                var colors = JSON.parse($(this).attr('data-color'));
                var lenFont = fonts.length;
                var lenColor = colors.length;
                var idApplyButton = uniqId;
                var optionFont = '';
                var optionColor = '';

                for(var i = 0; i < lenFont; i++){
                    var font = fonts[i];
                    optionFont = optionFont+'<option value="'+font.fontFamily+'" style="'+font.fontFamily+'">'+font.name+'</option>';
                }

                for(var i = 0; i < lenColor; i++){
                    var color = colors[i];
                    optionColor = optionColor+'<div>\
                                                <div data-id="'+idApplyButton+'"  class="frfu-custom-font-color" style="height: 40px; width: 40px; border-radius: 50%; background-color: '+color.value+'">\
                                                </div>\
                                                <div>\
                                                    <span>'+color.name+'</span>\
                                                </div>\
                                               </div>';
                }

                var toAppend = '<div id="text-custom-'+idApplyButton+'" class="row p-2 bg-light m-2 rounded">\
                                <span class="text-orientation-vartical position-absolute mt-3" style="margin-left: 92%; z-index: -1;"><span class="p-2 h-auto bg-dg vertical-label">Texte Personnalisé</span></span>\
                                <div class="form-group col-12">\
                                    <textarea class="form-control col-6" id="text_'+idApplyButton+'"></textarea>\
                                </div>\
                                <div class="col-12">\
                                    <div class="row">\
                                        <div class="col-md-6 d-flex justify-content-around">\
                                            '+optionColor+'\
                                        </div>\
                                        <div class="col-md-6 d-flex justify-content-center">\
                                            <select data-id="'+idApplyButton+'" class="mr-2 col-6 frfu-custom-text-font-family form-control">\
                                                <option value="">Sélectionner une police</option>\
                                                '+optionFont+'\
                                            </select>\
                                        </div>\
                                    </div>\
                                </div>\
                                <div class="form-group col-12">\
                                    <span data-id="'+idApplyButton+'" class="action-primary mr-auto ml-auto frfu-add-custom-text-button" data-price="{{getConfig('cost_by_letter').value}}">Appliquer</span>\
                                    <span data-id="'+idApplyButton+'" class="btn mr-auto ml-auto frfu-remove-custom-text-button text-danger">Supprimer</span>\
                                </div>\
                                </div>';

                $('#frfu-add-remove-custom-text').append(toAppend);                
                console.log(addCustomTextElement.find('.frfu-add-custom-text-button'));
            });

            $('#frfu-add-custom-text-element-reference').click(function(e){
                
                var uniqId = uniqKey();;
                var idApplyButton = uniqId;
                var fonts = JSON.parse($(this).attr('data-font'));
                var colors = JSON.parse($(this).attr('data-color'));
                var lenFont = fonts.length;
                var lenColor = colors.length;
                var idApplyButton = uniqId;
                var optionFont = '';
                var optionColor = '';

                for(var i = 0; i < lenFont; i++){
                    var font = fonts[i];
                    optionFont = optionFont+'<option value="'+font.fontFamily+'" style="'+font.fontFamily+'">'+font.name+'</option>';
                }

                for(var i = 0; i < lenColor; i++){
                    var color = colors[i];
                    optionColor = optionColor+'<div>\
                                                <div data-id="'+idApplyButton+'"  class="frfu-custom-font-color-identity" style="height: 40px; width: 40px; border-radius: 50%; background-color: '+color.value+'">\
                                                </div>\
                                                <div>\
                                                    <span>'+color.name+'</span>\
                                                </div>\
                                               </div>';
                }

                var toAppend = '<div id="text-custom-identity-'+idApplyButton+'" class="row p-2 bg-light m-2" style="both: clear; border-radius: 15px;">\
                                    <span class="text-orientation-vartical position-absolute mt-3" style="margin-left: 92%; z-index: -1;"><span class="p-2 h-auto bg-dg vertical-label">Texte d\'identité</span></span>\
                                    <div class="form-group col-6">\
                                        <input placeholder="Prénom" class="form-control col-6" id="firstName_'+idApplyButton+'">\
                                    </div>\
                                    <div class="form-group col-6">\
                                        <input placeholder="Nom" class="form-control col-6" id="name_'+idApplyButton+'">\
                                    </div>\
                                    <div class="form-group col-6">\
                                        <input placeholder="Date de naissance" class="form-control col-6" id="birthday_'+idApplyButton+'">\
                                    </div>\
                                    <div class="form-group col-6">\
                                        <input placeholder="Date du décès" class="form-control col-6" id="deathday_'+idApplyButton+'">\
                                    </div>\
                                    <div class="col-12">\
                                        <div class="row">\
                                            <div class="col-md-6 d-flex justify-content-around">\
                                                '+optionColor+'\
                                            </div>\
                                            <div class="col-md-6 d-flex justify-content-center">\
                                                <select data-id="'+idApplyButton+'" class="mr-2 col-6 frfu-custom-text-font-family-identity form-control">\
                                                    <option value="">Sélectionner une police</option>\
                                                    '+optionFont+'\
                                                </select>\
                                            </div>\
                                        </div>\
                                    </div>\
                                    <div class="col-12justify-content-around">\
                                        <span id="'+idApplyButton+'" class="btn btn-sm btn-dark frfu-add-custom-text-button-reference" data-price="{{getConfig('cost_by_letter').value}}">Appliquer</span>\
                                        <span data-id="'+idApplyButton+'" class="btn btn-sm btn-dark frfu-remove-custom-text-button-reference" data-price="{{getConfig('cost_by_letter').value}}">Supprimer</span>\
                                    </div>\
                                </div>';

                $('#frfu-add-remove-custom-text-reference').append(toAppend);                
                console.log(addCustomTextElement.find('.frfu-add-custom-text-button'));
            });

            img_granit.click(function(){
                var id = $(this).attr('data-id');

                var price = $(this).attr('data-price');
                var label = $(this).attr('data-label');
                var url_img = $(this).attr('data-url');
                var selStele = 'img[data-id-granit="'+id+'"]';
                var data_gl = $(this).attr('data-gallery-id');
                $('#order_custom_gallery option[value='+$(this).attr('data-gallery-id')+']').attr('selected', true);
                //$('#devis_gallery').val($(this).attr('data-gallery-id'));img_fixation
                $('.img-stele').parent().hide();
                $('.img_fixation').parent().hide();
                $('.img_fixation[data-gallery-id='+data_gl+']').parent().show();
                img_granit.parent().removeClass('border-choice');
                $(this).parent().addClass('border-choice');
                //$(selStele).parent().show();
                //$('#frfu-photo-product-to-customize img').attr('src', url_img);
               // $('#devis_total').val(price);
                /*var bgImg = new Image();
                bgImg.src = url_img;
                var coef = canvas.width/bgImg.width;*/

                if(url_img == '/'){
                    url_img = $('#frfu-preload-transparent-img').attr('src');
                }

                fabric.Image.fromURL(url_img, function(img) {
                    var center = canvas.getCenter();

                    var oImg = img.set({
                        top: center.top,
                        left: center.left,
                        originX: 'center',
                        originY: 'center',
                        width: canvas.width,
                        height: canvas.height,
                        uniqId: uniqKey(),
                        dataprice: price,
                        frfuLabelObject: 'Granite',
                        frfuNameObject: 'granit',
                        
                    });

                    objs = canvas._objects;
                    lengthObjs = objs.length;
                    var i = 0;
                    var index = null;
                    var found = false;
                    objs.forEach(obj => {
                        if(obj.frfuNameObject == 'granit'){
                            index = i;
                            found = true;
                        }
                        i++;
                    });

                    if(found){
                        
                        canvas._objects[index].dataprice = price;
                        console.log(canvas._objects[index]._element.src);
                        canvas._objects[index]._element.src = url_img;
                        canvas.renderAll();
                    }else{
                        canvas.add(oImg);
                        canvas.renderAll();
                    }
                    
                    priceAndItems();
                }, {
                    selectable: false
                });
            });

            img_fixation.click(function(){
                var id = $(this).attr('data-id');
                var url = $(this).attr('data-url');
                fabric.Image.fromURL(url, function(img) {
                    var center = canvas.getCenter();
                    var oImg = img.set({
                        top: 0,
                        left: 0,
                        selectable: false,
                        uniqId: uniqKey(),
                        fixationId: id,
                        dataprice: 0,
                        frfuLabelObject: 'Fixation',
                        frfuNameObject: 'fixation'
                    }).scale(0.9);

                    objs = canvas._objects;
                    lengthObjs = objs.length;
                    var i = 0;
                    var index = null;
                    var found = false;
                    objs.forEach(obj => {
                        if(obj.frfuNameObject == 'fixation'){
                            index = i;
                            found = true;
                        }
                        i++;
                    });

                    if(found){
                        canvas._objects[index].dataprice = 0;
                        canvas._objects[index]._element.src = url;
                        canvas.renderAll();
                    }else{
                        canvas.add(oImg);
                        canvas.renderAll();
                    }
                    
                    priceAndItems();
                });
                $('#order_custom_fixation option[value='+id+']').attr('selected', true);
                bgImg.src = $(this).attr('src');
                img_fixation.parent().removeClass('border-choice');
                $(this).parent().addClass('border-choice');
            });

            $('#frfu-previous-step').click(function(){
                console.log('caught !!!'); 
                if(currentStep !== 1){
                    currentStep = currentStep - 1;
                }
                
                console.log(currentStep);
                $('div.step[data-target="#step-'+currentStep+'"]').trigger('click');
                $('div.step').removeClass('active');
                $('div.step[data-target="#step-'+currentStep+'"]').addClass('active');
                $(window).trigger('resize');
            });

            $('#frfu-next-step').click(function(){
                if(!$('div.step[data-target="#step-'+currentStep+1+'"]').hasClass('disabled') && currentStep < 7){
                    currentStep = currentStep + 1;
                    console.log(currentStep); 
                    $('div.step[data-target="#step-'+currentStep+'"]').trigger('click');
                    $('div.step').removeClass('active');
                    $('div.step[data-target="#step-'+currentStep+'"]').addClass('active');
                    $(window).trigger('resize');
                    if(currentStep > 1 && $('#frfu-previous-step').hasClass('d-none')){
                        $('#frfu-previous-step').removeClass('d-none');
                    }
                }
                
            });

            allNextBtn.click(function () {
                var idInputToVerify = $(this).attr('data-id'),

                    next_step = 'div[data-target="'+$(this).attr('data-next')+'"]';
                {% set need = prod.subCatId.needSteleFixation == 1 ? 1 : 0 %}
                var need = {{need}};
                var input = $(idInputToVerify).val();
                var inputOrder = '';
                
                
                if(input){
                   $('#granit-msg').hide();
                   $(next_step).find('.btn').attr('class', 'btn btn-success btn-circle');   
                   $('.steps .step').removeClass('active');
                   $(next_step).addClass('active');
                   $(next_step).removeClass('disabled');
                   $(next_step).trigger('click');
                   if(!$($(this).attr('data-msg')).hasClass('d-none')){
                       $($(this).attr('data-msg')).addClass('d-none');
                   }
                   currentStep = Number($(this).attr('data-next').split('-')[1]);
                   switchStepElement();
                }
                else{
                    $($(this).attr('data-msg')).removeClass('d-none');
                }

                $(window).trigger('resize');
            });
             
             function apply(){
                var id = $(this).attr('id');
                var input = $(this).parent().find('input');
                console.log(input); 
             }//

             $('#frfu-add-remove-custom-text').delegate('.frfu-add-custom-text-button', 'click', function(){
                var id = $(this).attr('data-id');
                var input = $('#text_'+id);
                var val = input.val();
                var txt_price = Number($(this).attr('data-price')) * val.length;
                var elExist = elmentExists(id);
                console.log(elExist);
                if(elExist !== false ){
                    var obj = canvas._objects[elExist];
                    obj.text = val;
                    obj.dataprice = txt_price;
                    canvas._objects[elExist] = obj;
                    canvas.requestRenderAll();
                    priceAndItems();
                }
                else{
                    var text = new fabric.Textbox(val, {
                        width:250,
                        cursorColor :"blue",
                        top:10,
                        left:10,
                        editable: false,
                        uniqId: id,
                        dataprice: txt_price,
                        frfuLabelObject: 'Texte Personnalise',
                        frfuNameObject: 'text-custom'
                    });
                    canvas.add(text);
                    canvas.requestRenderAll();
                    priceAndItems();
                }
                
            });

            $('#frfu-add-remove-custom-text-reference').delegate('.frfu-remove-custom-text-button-reference', 'click', function(){
                var id = $(this).attr('data-id');
                var elExist = elmentExists(id);
                console.log(elExist);
                if(elExist !== false ){
                    var obj = canvas._objects[elExist];
                    canvas.remove(obj);
                    canvas.requestRenderAll();
                    //$('#text-custom-identity-'+id).remove();
                    priceAndItems();
                }
                
            });

            $('#frfu-add-remove-custom-text-reference').delegate('.frfu-add-custom-text-button-reference', 'click', function(){
                var id = $(this).attr('id');
                var name = $('#name_'+id);
                var firstName = $('#firstName_'+id);
                var birthday = $('#birthday_'+id);
                var deathday = $('#deathday_'+id);

                var firstText = new fabric.Textbox(firstName.val(), {
                    fontFamily: "Comic Sans",
                    fontSize: 14,
                    left: 10,
                    top: 10,
                    uniqId: 'firstName_'+id,
                    dataprice: Number($(this).attr('data-price')) * firstName.val().length
                });

                var secondText = new fabric.Textbox(name.val(), {
                    fontFamily: "Comic Sans",
                    fontSize: 14,
                    left: firstText.width + 20,
                    top: 10,
                    uniqId: 'name_'+id,
                    dataprice: Number($(this).attr('data-price')) * name.val().length
                });

                var thirdText = new fabric.Textbox(birthday.val(), {
                    fontFamily: "Comic Sans",
                    fontSize: 14,
                    left: 10,
                    top: 40,
                    uniqId: 'birthday_'+id,
                    dataprice: Number($(this).attr('data-price')) * birthday.val().length
                });

                var fourthText = new fabric.Textbox(deathday.val(), {
                    fontFamily: "Comic Sans",
                    fontSize: 14,
                    left: thirdText.width + 20,
                    top: 40,
                    uniqId: 'deathday_'+id,
                    dataprice: Number($(this).attr('data-price')) * deathday.val().length
                });

                var elExist = elmentExists(id);
                console.log(elExist);
                if(elExist !== false ){
                    var obj = canvas._objects[elExist];
                    canvas.remove(obj);
                    canvas.requestRenderAll();
                    var textGroup = new fabric.Group([firstText, secondText, thirdText, fourthText], {
                        left: 50,
                        top: 50,
                        subTargetCheck: true,
                        uniqId: id,
                        dataprice: firstText.dataprice + secondText.dataprice + thirdText.dataprice + fourthText.dataprice,
                        frfuNameObject: 'text-custom-identity',
                        frfuLabelObject: 'Texte Identité Personnalise',
                    });
                    canvas.add(textGroup);
                    canvas.requestRenderAll();
                    priceAndItems();
                }
                else{
                    var textGroup = new fabric.Group([firstText, secondText, thirdText, fourthText], {
                        left: 50,
                        top: 50,
                        subTargetCheck: true,
                        uniqId: id,
                        dataprice: firstText.dataprice + secondText.dataprice + thirdText.dataprice + fourthText.dataprice,
                        frfuNameObject: 'text-custom-identity',
                        frfuLabelObject: 'Texte Identité Personnalise',

                    });
                    canvas.add(textGroup);
                    canvas.requestRenderAll();
                    priceAndItems();
                }
                 console.log(canvas._objects);
            });

            $('#frfu-add-remove-custom-text').delegate('.frfu-remove-custom-text-button', 'click', function(){
                var id = $(this).attr('data-id');
                var elExist = elmentExists(id);
                console.log(elExist);
                if(elExist !== false ){
                    var obj = canvas._objects[elExist];
                    canvas.remove(obj);
                    canvas.requestRenderAll();
                    //$('#text-custom-'+id).remove(); 
                    priceAndItems();
                }
                
            })

            $('#frfu-add-remove-custom-text').delegate('.frfu-custom-text-size-plus', 'mousedown', function(){
                    var id = $(this).attr('data-id');
                    var elExist = elmentExists(id);
                    console.log(elExist);
                    if(elExist !== false ){
                        var obj = canvas._objects[elExist];
                        obj.set('fontSize', obj.get('fontSize')+1);
                        canvas._objects[elExist] = obj;
                        canvas.requestRenderAll();
                    }
            });

            $('#frfu-add-remove-custom-text').delegate('.frfu-custom-text-size-minus', 'mousedown', function(){
                    var id = $(this).attr('data-id');
                    var elExist = elmentExists(id);
                    console.log(elExist);
                    if(elExist !== false ){
                        var obj = canvas._objects[elExist];
                        obj.set('fontSize', obj.get('fontSize')-1);
                        canvas._objects[elExist] = obj;
                        canvas.requestRenderAll();
                        priceAndItems();
                    }
            });

            $('#frfu-add-remove-custom-text').delegate('.frfu-custom-text-position-up', 'mousedown', function(){
                    var id = $(this).attr('data-id');
                    var elExist = elmentExists(id);
                    console.log(elExist);
                    if(elExist !== false ){
                        var obj = canvas._objects[elExist];
                        obj.set('top', obj.get('top')-1);
                        canvas._objects[elExist] = obj;
                        canvas.requestRenderAll();
                    }
            });

            $('#frfu-add-remove-custom-text').delegate('.frfu-custom-text-position-down', 'mousedown', function(){
                var id = $(this).attr('data-id');
                    var elExist = elmentExists(id);
                    console.log(elExist);
                    if(elExist !== false ){
                        var obj = canvas._objects[elExist];
                        obj.set('top', obj.get('top')+1);
                        canvas._objects[elExist] = obj;
                        canvas.requestRenderAll();
                    }
            });

            $('#frfu-add-remove-custom-text').delegate('.frfu-custom-text-position-left', 'mousedown', function(){
                    var id = $(this).attr('data-id');
                    var elExist = elmentExists(id);
                    console.log(elExist);
                    if(elExist !== false ){
                        var obj = canvas._objects[elExist];
                        obj.set('left', obj.get('left')-1);
                        canvas._objects[elExist] = obj;
                        canvas.requestRenderAll();
                    }
            });

            $('#frfu-add-remove-custom-text').delegate('.frfu-custom-text-position-right', 'mousedown', function(){
                    var id = $(this).attr('data-id');
                    var elExist = elmentExists(id);
                    console.log(elExist);
                    if(elExist !== false ){
                        var obj = canvas._objects[elExist];
                        obj.set('left', obj.get('left')+1);
                        canvas._objects[elExist] = obj;
                        canvas.requestRenderAll();
                    }
            });


            $('#frfu-upload-custom-img').change(function(){
                var fd = new FormData(); 
                var files = $(this)[0].files[0];
                var metaData = $(this).attr('data-meta');
                fd.append('custom-img', files); 
                var price = Number($(this).attr('data-price'));
                console.log(price);
                $.ajax({ 
                    url: $(this).attr('data-upload-url'), 
                    type: 'post', 
                    data: fd, 
                    contentType: false, 
                    processData: false, 
                    success: function(response){ 
                        
                        var cprice = Number(price) + Number($('#frfu-custom-price-images').text());
                        var price_total = Number($($('.frfu-custom-total-price')[0]).text()) + price;
                        console.log(price);
                        console.log(cprice);
                        console.log(price_total);
                        var pugImg = new Image();
                        pugImg.onload = function (img) {
                            var uniqId = uniqKey(); 

                            var rect = new fabric.Rect({
                                left: 100,
                                top: 100,
                                width: pugImg.width,
                                height: pugImg.height,
                                stroke: '',
                                strokeWidth: 10,
                                rx:10,
                                ry:10,
                                strokeDashArray: [10, 5],
                                frfuNameObject: 'motif',
                                frfuLabelObject: 'Motif Personalisé',
                                dataprice: price,
                                uniqId: uniqId
                            });
                            canvas.add(rect);

                            fabric.util.loadImage(pugImg.src, function (img) {
                                rect.setPatternFill({
                                    source: img,
                                    repeat: 'no-repeat',
                                    //patternTransform: [0.2, 0, 0, 0.2, 0, 0]
                                });
                                canvas.requestRenderAll();
                            });
                            /*var pug = new fabric.Image(pugImg, {
                                angle: 45,
                                width: img.width/4,
                                height: img.height/4,
                                left: 50,
                                top: 70,
                                scaleX: .25,
                                scaleY: .25,
                                
                            });
                            canvas.add(pug);*/
                            priceAndItems();
                            $('#frfu-motif-uploaded').append('<div class="col-12 p-2">\
                                <div class="row"><img height="40px" src="'+pugImg.src+'"> \
                                <span id="'+uniqId+'" class="text-dander frfu-motif-item-remove">Supprimer</span>\
                                </div><div class="row">\
                                    <div class="col-3 p-2"><span>Couleur du motif</span>\
                                </div>\
                                <div class="col-9 p-2 d-flex justify-content-around">\
                                    <div style="background-color: ; width: 40px; height: 40px; border-radius: 50%;" data-id="'+uniqId+'" data-color="black" class="frfu-motif-custom-item-color"></div>\
                                    <div style="background-color: black; width: 40px; height: 40px; border-radius: 50%;" data-id="'+uniqId+'" data-color="black" class="frfu-motif-custom-item-color"></div>\
                                    <div style="background-color: white; width: 40px; height: 40px; border-radius: 50%;" data-id="'+uniqId+'"  data-color="white" class="frfu-motif-custom-item-color"></div>\
                                    <div style="background-color: yellow; width: 40px; height: 40px; border-radius: 50%;" data-id="'+uniqId+'"  data-color="gold" class="frfu-motif-custom-item-color"></div>\
                                </div>\
                                <div class="col-12 p-2">\
                                    <div style="background-color: transparent;" data-id="'+uniqId+'" data-color="transparent" class="frfu-motif-custom-item-color"><button>Enlever la couleur</button></div>\
                                </div>\
                                </div></div>');
                            $('#frfu-custom-img').show(); 
                            $('#frfu-upload-custom-img').val('');
                        };
                        pugImg.src = '/'+response.location;
                    },
                    error: function(err){ 
                        console.log(err);
                    },
                }); 
            });


            $('#frfu-add-order-action').click(function(){
                buildInsertMetaData();
                setTimeout(function(){
                    $('#devis-form').trigger('submit');
                }, 2000);
                
            });

           /* $('#devis-form').submit(function(e){
                e.preventDefault();
                console.log('La requete est lancé');
                $('#pass-step-5').prop('disabled', true);
                
                var form = new FormData($(this)[0]);
                if(!processing){
                    processing = true;
                    $.ajax({
                        url: '{{url('product-customize', {'id' : prod.id})}}',
                        type: 'post',
                        data: form,
                        contentType: false, 
                        processData: false, 
                        success: function(response){
                            console.log(response);
                            $('#more_info_devis').append('<option value="'+response.devis+'" selected></option>');
                            $('#pass-step-5').trigger('click');
                            //$('#pass-step-5').prop('disabled', false);
                        },
                        error: function(error){
                            console.log(error);
                            processing = false;
                        }
                    });
                }
                
            });*/

            $('#frfu-motif-selected, #frfu-motif-uploaded').delegate('.frfu-motif-item-remove', 'click', function(){
                var uniqId = $(this).attr('id');
                 objs = canvas._objects;
                lengthObjs = objs.length;
                objs.forEach(obj => {
                    if(obj.uniqId == uniqId ){

                        var cprice = Number($('#frfu-custom-price-images').text()) - obj.dataprice;
                        var price_total = Number($($('.frfu-custom-total-price')[0]).text()) - obj.dataprice;
                         $('#frfu-custom-price-images').text(cprice);
                         $('.frfu-custom-total-price').text(price_total);
                        //console.log(price);
                        canvas.remove(obj);
                        $(this).parent().parent().remove();
                    }
                });
                
            });//


            $('#frfu-motif-selected').delegate('.frfu-motif-item-color', 'click', function(){
                var uniqId = $(this).attr('data-id');
                var url = $(this).attr('data-url');
                var i = elmentExists(uniqId);
                console.log(i);//
                if(i !== false){
                    canvas._objects[i].setSrc(url,function(){
                        canvas.requestRenderAll();
                    },{crossOrigin:'annonymous'});
                }
            });

            $('#frfu-motif-uploaded').delegate('.frfu-motif-custom-item-color', 'click', function(){
                var uniqId = $(this).attr('data-id');
                var color = $(this).attr('data-color');
                var i = elmentExists(uniqId);
                console.log(i);//frfu-motif-custom-item-color
                if(i !== false){
                    canvas._objects[i].filters = [];
                    canvas._objects[i].set({'stroke' : color});
                    canvas.requestRenderAll();
                }
            });

            $('body').delegate('.frfu-cadre', 'change', function(){
                var id = $(this).attr('data-uniq');
                if($(this).val() !== '' && $(this).val() !== null){
                    $('#frfu-field-photo-cadre-'+id).removeClass('d-none');
                }
            });

            $('body').delegate('.frfu-gravure', 'change', function(){
                var id = $(this).attr('data-uniq');
                if($(this).val() !== '' && $(this).val() !== null){
                    $('#frfu-field-photo-gravure-'+id).removeClass('d-none');
                }
            });
            
            $('body').delegate('.frfu-cadre-import', 'click', function(){//frfu-field-photo-cadre

                var fd = new FormData(); 
                var padding = 0;
                var id = $(this).attr('data-id');
                var file = $('.frfu-field-photo-cadre[data-id='+id+']')[0].files[0];
                fd.append('custom-img', file); 
                var selected = $('#frfu-cadre-'+id+' option:selected');
                var isCircle = selected.attr('data-circle') == '1' ? true : false;
                var ovale = selected.attr('data-ovale');
                var img_cadre = selected.attr('data-image');
                var dataprice = selected.attr('data-price');
                var width = selected.attr('data-width');
                var height = selected.attr('data-height');

                var buildCadre = function(src){
                    var cadre = new fabric.Image.fromURL(src, function(img) {
                    img.scaleToWidth(200);
                    var patternSourceCanvas = new fabric.StaticCanvas();
                    patternSourceCanvas.add(img);
                    patternSourceCanvas.renderAll();
                    var pattern = new fabric.Pattern({
                    source: function() {
                        patternSourceCanvas.setDimensions({
                        width: img.getScaledWidth() + padding,
                        height: img.getScaledHeight() + padding
                        });
                        patternSourceCanvas.renderAll();
                        return patternSourceCanvas.getElement();
                    },
                    repeat: 'no-repeat',
                    uniqId: id,
                    originX: 'center',
                    originY: 'center'
                    });
                    
                    var exist = elmentExists(id);
                    if(exist !== false){
                        canvas.remove(canvas._objects[exist]);
                        if(isCircle === true){
                            var circle = new fabric.Circle({
                                radius: Number(width),
                                fill: pattern,
                                left: 50,
                                top: 50,
                                stroke: '',
                                strokeWidth: 3,
                                uniqId: id,
                                frfuNameObject: 'photo',
                                dataprice: dataprice,
                                frfuLabelObject: 'Photo Cadre',
                                objectCaching: false
                            });
                            //patterns.push(pattern);
                            canvas.add(circle);
                        }
                        else if(ovale === true){
                            ellipse = new fabric.Ellipse({
                                left: 150,
                                top: 150,
                                originX: 'left',
                                originY: 'top',
                                rx: Number(width),
                                ry: Number(height),
                                angle: 0,
                                fill: pattern,
                                stroke:'',
                                strokeWidth:3,
                                uniqId: id,
                                frfuNameObject: 'photo',
                                frfuLabelObject: 'Photo Cadre',
                                dataprice: dataprice,
                                objectCaching: false
                            });
                            
                            canvas.add(ellipse);
                        }
                        else{
                            fabric.loadSVGFromURL(link_image(img_cadre), function(objects, options) {
                                var shape = fabric.util.groupSVGElements(objects, options);
                                shape.set({
                                    left: 250,
                                    top: 100,
                                    fill: pattern,
                                    width: Number(width),
                                    height: Number(height),
                                    stroke:'',
                                    strokeWidth:3,
                                    uniqId: id,
                                    frfuNameObject: 'photo',
                                    frfuLabelObject: 'Photo Cadre',
                                    dataprice: dataprice,
                                    objectCaching: false
                                });
                                //patterns.push(pattern);
                                canvas.add(shape);
                            });
                        }
                        priceAndItems();
                        var indexPattern = getPattern(id);
                        patterns[indexPattern][0] = pattern;
                        patterns[indexPattern][1] = img;
                    }else{
                        if(isCircle === true){
                            var circle = new fabric.Circle({
                                radius: Number(width),
                                fill: pattern,
                                left: 50,
                                top: 50,
                                stroke: '',
                                strokeWidth: 3,
                                uniqId: id,
                                frfuNameObject: 'photo',
                                dataprice: dataprice,
                                frfuLabelObject: 'Photo Cadre',
                                objectCaching: false
                            });
                            //patterns.push(pattern);
                            canvas.add(circle);
                            priceAndItems();
                        }
                        else if(ovale === true){
                            ellipse = new fabric.Ellipse({
                                left: 150,
                                top: 150,
                                originX: 'left',
                                originY: 'top',
                                rx: Number(width),
                                ry: Number(height),
                                angle: 0,
                                fill: pattern,
                                stroke:'',
                                strokeWidth:3,
                                uniqId: id,
                                frfuNameObject: 'photo',
                                frfuLabelObject: 'Photo Cadre',
                                dataprice: dataprice,
                                objectCaching: false
                            });
                            
                            canvas.add(ellipse);
                            priceAndItems();
                        }
                        else{
                            fabric.loadSVGFromURL(link_image(img_cadre), function(objects, options) {
                                var shape = fabric.util.groupSVGElements(objects, options);
                                shape.set({
                                    left: 250,
                                    top: 100,
                                    fill: pattern,
                                    width: Number(width),
                                    height: Number(height),
                                    stroke:'',
                                    strokeWidth:3,
                                    uniqId: id,
                                    frfuNameObject: 'photo',
                                    frfuLabelObject: 'Photo Cadre',
                                    dataprice: dataprice,
                                    objectCaching: false
                                });
                                //patterns.push(pattern);
                                canvas.add(shape);
                                priceAndItems();
                            });
                        }
                        patterns.push([pattern, img]);
                    }

                    
                    
                    //imgs.push(img);
                    
                });

                }

                var fileReader = new FileReader();

                fileReader.onload = function(fileLoadedEvent) {
                    console.log(fileLoadedEvent);
                    var srcData = fileLoadedEvent.target.result; // <--- data: base64
                    buildCadre(srcData);
                    canvas.requestRenderAll();
                }

                fileReader.readAsDataURL(file);
               /* $.ajax({ 
                    url: $('#frfu-upload-custom-img').attr('data-upload-url'), 
                    type: 'post', 
                    data: fd, 
                    contentType: false, 
                    processData: false, 
                    success: function(response){ 
                        
                        
                        fileReader.src = '/'+response.location;
                    },
                    error: function(err){ 
                        console.log(err);
                    },
                }); */
            });

            $('body').delegate('.frfu-gravure-photo-import', 'click', function(){// frfu-field-photo-gravure
                var fd = new FormData(); 
                var padding = 0;
                var id = $(this).attr('data-id');
                var file = $('.frfu-field-photo-gravure[data-id='+id+']')[0].files[0];
                fd.append('custom-img', file); 
                var selected = $('#frfu-gravure-'+id+' option:selected');
                var isCircle = selected.attr('data-circle') == '1' ? true : false;
                var ovale = selected.attr('data-ovale');
                var img_cadre = selected.attr('data-image');
                var dataprice = selected.attr('data-price');
                var width = selected.attr('data-width');
                var height = selected.attr('data-height');
                console.log(img_cadre);
                var buildCadre = function(src){
                    var cadre = new fabric.Image.fromURL(src, function(img) {
                        img.scaleToWidth(200);
                        img.filters.push(new fabric.Image.filters.Grayscale());
                        img.applyFilters();
                        var patternSourceCanvas = new fabric.StaticCanvas();
                        patternSourceCanvas.add(img);
                        patternSourceCanvas.renderAll();
                        var pattern = new fabric.Pattern({
                        source: function() {
                            patternSourceCanvas.setDimensions({
                            width: img.getScaledWidth() + padding,
                            height: img.getScaledHeight() + padding
                            });
                            patternSourceCanvas.renderAll();
                            return patternSourceCanvas.getElement();
                        },
                        repeat: 'no-repeat',
                        uniqId: id,
                        originX: 'center',
                        originY: 'center'
                        });
                        
                        var exist = elmentExists(id);
                        if(exist !== false){
                            canvas.remove(canvas._objects[exist]);
                            fabric.loadSVGFromURL(link_image(img_cadre), function(objects, options) {
                                var shape = fabric.util.groupSVGElements(objects, options);
                                var len = shape.getObjects().length;
                                for(var i = 0; i < len; i++){
                                    if(i == len-1){
                                        shape._objects[i].fill =  pattern;
                                    }
                                }
                                shape.set({
                                    left: 250,
                                    top: 100,
                                    uniqId: id,
                                    frfuNameObject: 'photo_gravure',
                                    frfuLabelObject: 'Photo Gravure',
                                    dataprice: dataprice,
                                    objectCaching: false
                                });
                                
                                canvas.add(shape);
                                priceAndItems();
                            });
                            var indexPattern = getPattern(id);
                            patterns[indexPattern][0] = pattern;
                            patterns[indexPattern][1] = img;
                        }else{
                            fabric.loadSVGFromURL(link_image(img_cadre), function(objects, options) {
                                var shape = fabric.util.groupSVGElements(objects, options);
                                var len = shape.getObjects().length;
                                for(var i = 0; i < len; i++){
                                    if(i == len-1){
                                        shape._objects[i].fill =  pattern;
                                    }
                                }
                                shape.set({
                                    left: 250,
                                    top: 100,
                                    uniqId: id,
                                    frfuNameObject: 'photo_gravure',
                                    frfuLabelObject: 'Photo Gravure',
                                    dataprice: dataprice,
                                    objectCaching: false
                                });
                                
                                canvas.add(shape);
                                priceAndItems();
                            });
                            patterns.push([pattern, img]);
                        }
                    });

                }

               var fileReader = new FileReader();

                fileReader.onload = function(fileLoadedEvent) {
                    console.log(fileLoadedEvent);
                    var srcData = fileLoadedEvent.target.result; // <--- data: base64
                    buildCadre(srcData);
                    canvas.requestRenderAll();
                }

                fileReader.readAsDataURL(file);

                /*$.ajax({ 
                    url: $('#frfu-upload-custom-img').attr('data-upload-url'), 
                    type: 'post', 
                    data: fd, 
                    contentType: false, 
                    processData: false, 
                    success: function(response){ 
                        
                        
                        fileReader.src = '/'+response.location;
                    },
                    error: function(err){ 
                        console.log(err);
                    },
                }); */
                
                
            });

            $('#frfu-add-cadre-action').click(function(){
                generatePhotoDiv();
            });

            function photoTopBottom(uniqId, num, axe){
                var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var pattern = patterns[indexPattern][0];
                console.log(patterns);
                //var pattern = obj.fill;
                //console.log(pattern);
                if(axe === 'x'){
                    pattern.offsetX = pattern.offsetX+num;
                }else{
                    pattern.offsetY = pattern.offsetY+num;
                }
                
                obj.fill = pattern;
                canvas._objects[index] = obj;
                patterns[indexPattern][0] = pattern;
                canvas.requestRenderAll();
            }

            function photogravureTopBottom(uniqId, num, axe){
                var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var pattern = patterns[indexPattern][0];
                var img = patterns[indexPattern][1];
                console.log(patterns);
                //canvas.setActiveObject(obj);
                //obj = canvas.getActiveObject();
                var len = obj.getObjects().length;
                if(axe === 'x'){
                    
                    for(var i = 0; i < len; i++){
                        obj.getObjects()[i].set({objectCaching: false});
                        if(i == len-1){
                            var fill = obj._objects[i].fill;
                            var x =  obj._objects[i].fill.offsetX+num;
                            fill.offsetX = x;
                            obj.getObjects()[i].set({fill: fill});
                            patterns[indexPattern][0] = fill;
                            canvas.requestRenderAll();
                        }
                    }
                }else{
                    for(var i = 0; i < len; i++){
                        obj.getObjects()[i].set({objectCaching: false});
                        if(i == len-1){
                            var fill = obj._objects[i].fill;
                            var y =  obj._objects[i].fill.offsetY+num;
                            fill.offsetY = y;
                            obj.getObjects()[i].set({fill: fill});
                            patterns[indexPattern][0] = fill;
                            canvas.requestRenderAll();
                        }
                    }
                }


                
            }
          
            function photoBorder(uniqId, num, color){
                var index = elmentExists(uniqId);
                var obj = canvas._objects[index];
                obj.stroke = color;
                obj.strokeWith = num;
                canvas._objects[index] = obj;
                canvas.requestRenderAll();
                console.log(obj);
            }

            $('body').delegate('.frfu-custom-photo-position-up', 'click', function(){ 
                
                
                var uniqId =  $(this).attr('data-id');
                photoTopBottom(uniqId, -1, 'y')
                //console.log(canvas);
            });

            $('body').delegate('.frfu-custom-photogravure-position-up', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photogravureTopBottom(uniqId, -3, 'y')
                console.log(canvas);
            });

            $('body').delegate('.frfu-custom-photo-position-down', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photoTopBottom(uniqId, 1, 'y')
            });

             $('body').delegate('.frfu-custom-photogravure-position-down', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photogravureTopBottom(uniqId, 3, 'y')
                //console.log(canvas);
            });

            $('body').delegate('.frfu-custom-photo-position-left', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photoTopBottom(uniqId, -1, 'x')
            });

            $('body').delegate('.frfu-custom-photogravure-position-left', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photogravureTopBottom(uniqId, -1, 'x')
            });

            $('body').delegate('.frfu-custom-photo-position-right', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photoTopBottom(uniqId, 1, 'x')
            });

            $('body').delegate('.frfu-custom-photogravure-position-right', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photogravureTopBottom(uniqId, 1, 'x')
            });
            
            $('body').delegate('.frfu-custom-photogravure-size-plus', 'click', function(){
                
                var uniqId =  $(this).attr('data-id');
                
                 var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var img = patterns[indexPattern][1];
                //pattern.scaleToWidth = 150;
                //console.log(img.scaleToWidth);
                img.scaleToWidth(img.getScaledWidth()+2);
                //photoTopBottom(uniqId, 1, 'x')
                //obj.fill = pattern;
                patterns[indexPattern][1] = img;
                canvas.requestRenderAll();
                console.log(obj);
                
            });

            $('body').delegate('.frfu-custom-photogravure-size-minus', 'click', function(){
                
                var uniqId =  $(this).attr('data-id');
                
                 var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var img = patterns[indexPattern][1];
                //pattern.scaleToWidth = 150;
                //console.log(img.scaleToWidth);
                img.scaleToWidth(img.getScaledWidth()-2);
                //photoTopBottom(uniqId, 1, 'x')
                //obj.fill = pattern;
                patterns[indexPattern][1] = img;
                canvas.requestRenderAll();
                console.log(obj);
                
            });


            $('body').delegate('.frfu-custom-photo-size-minus', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                
                 var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var img = patterns[indexPattern][1];
                //pattern.scaleToWidth = 150;
                //console.log(img.scaleToWidth);
                img.scaleToWidth(img.getScaledWidth()-2);
                //photoTopBottom(uniqId, 1, 'x')
                //obj.fill = pattern;
                patterns[indexPattern][1] = img;
                canvas._objects[index] = obj;
                canvas.requestRenderAll();
                console.log(obj);
            });

            $('body').delegate('.frfu-custom-photo-size-plus', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                
                 var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var img = patterns[indexPattern][1];
                //pattern.scaleToWidth = 150;
                //console.log(img.scaleToWidth);
                img.scaleToWidth(img.getScaledWidth()+2);
                //photoTopBottom(uniqId, 1, 'x')
                //obj.fill = pattern;
                patterns[indexPattern][1] = img;
                canvas._objects[index] = obj;
                canvas.requestRenderAll();
                console.log(obj);
            });

            $('body').delegate('.frfu-cadre-border-none', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photoBorder(uniqId, 0, '');
            });

            $('body').delegate('.frfu-cadre-border-filet-or', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photoBorder(uniqId, 2, 'gold');
            });

            $('body').delegate('.frfu-cadre-border-bord-or', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photoBorder(uniqId, 4, 'gold');
            });

            $('body').delegate('.frfu-cadre-border-bord-blanc', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                photoBorder(uniqId, 4, 'white');
            });

            $('body').delegate('.frfu-cadre-photo-filter-color', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var img = patterns[indexPattern][1];
                console.log(img);
                img.filters = [];
                img.applyFilters();
                patterns[indexPattern][1] = img;
                canvas._objects[index] = obj;
                canvas.requestRenderAll();
            });

            $('body').delegate('.frfu-cadre-photo-filter-white-black', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var img = patterns[indexPattern][1];
                console.log(img);
                img.filters = [];
                img.filters.push(new fabric.Image.filters.Grayscale());
                
                img.applyFilters();
                patterns[indexPattern][1] = img;
                canvas._objects[index] = obj;
                canvas.requestRenderAll();
            });

            $('body').delegate('.frfu-cadre-photo-filter-sepia', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                var img = patterns[indexPattern][1];
                console.log(img);
                img.filters = [];
                img.filters.push(new fabric.Image.filters.Sepia());
                img.applyFilters();
                patterns[indexPattern][1] = img;
                canvas._objects[index] = obj;
                canvas.requestRenderAll();
            });

            $('body').delegate('.frfu-cadre-remove', 'click', function(){
                var uniqId =  $(this).attr('data-id');
                var index = elmentExists(uniqId);
                var indexPattern = getPattern(uniqId);
                var obj = canvas._objects[index];
                canvas.remove(obj);
                $('#frfu-photo-div-item-'+uniqId).remove();
                $('#frfu-gravure-div-item-'+uniqId).remove();
                 priceAndItems();//frfu-gravure-div-item-
            });// frfu-add-cadre-gravure-msg-block

            $('#frfu-add-cadre-gravure-msg-accept').click(function(){
                var granite = $($('.img-granit[data-gravure=1]')[0]);
                var id_gallery =  $($('.img-granit[data-gravure=1]')[0]).attr('data-gallery-id');
                var fixations = $('.img_fixation[data-gallery-id='+id_gallery+']');
                console.log(fixations);
                var fixation = null;
                objs = canvas._objects;
                lengthObjs = objs.length;
                var i = 0;
                var index = null;
                var found = false;
                objs.forEach(obj => {
                    if(obj.frfuNameObject == 'fixation'){
                        index = i;
                        found = true;
                    }
                    i++;
                });
                var id = canvas._objects[index].fixationId;
                for(var i = 0; i < fixations.length; i++){
                    if($(fixations[i]).attr('data-id') == id){
                        fixation = $(fixations[i]);
                    }
                }
                
                setTimeout(function(){
                    granite.trigger('click');
                }, 1000);
                setTimeout(function(){
                    fixation.trigger('click');
                }, 1000);
                
                $("#frfu-add-cadre-gravure-msg-block").remove();

                $("#frfu-add-gravure-action").trigger('click');//frfu-add-cadre-gravure-block frfu-add-gravure-action
            });

            $("#frfu-add-gravure-action").click(function(){
                generateGravureDiv();
                $('#frfu-add-cadre-gravure-block').removeClass('d-none');
                $(this).removeClass('d-none');
            });

            /*document.getElementById('img-width').oninput = function() {
            img.scaleToWidth(parseInt(this.value, 10));
            canvas.requestRenderAll();
            };
            */
            (function(){
                var preload = $('#frfu-preload-all-img');
                var preImgs = JSON.parse(preload.attr('data-preload'));
                var countPreImgs = preImgs.length;
                for(var k = 0; k < countPreImgs; k++){
                    var imgToAppend = new Image();
                    imgToAppend.src = preImgs[k];
                    preload.append(imgToAppend);
                } 
            })();
            $('#frfu-add-cadre-action').trigger('click');//
            $('div.steps .active').trigger('click');
            addCustomTextElement.trigger('click');
            $('#frfu-add-custom-textelement-reference').trigger('click');
            setTimeout(function(){
                $('#frfu-ask-call-button').trigger('click');
            }, 2000);

            $('#frfu-add-custom-text-element-reference').trigger('click');
        });
    </script>
        
{% endblock %}