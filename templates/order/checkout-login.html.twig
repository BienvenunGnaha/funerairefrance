{% extends 'base.html.twig' %}

{% block title %}Connexion avant achat{% endblock %}

{% block stylesheets %}
        <style>
            .stepwizard-step p {
                margin-top: 0px;
                color:#666;
            }
            .stepwizard-row {
                display: table-row;
            }
            .stepwizard {
                display: table;
                width: 100%;
                position: relative;
            }
            .stepwizard-step button[disabled] {
                /*opacity: 1 !important;
                filter: alpha(opacity=100) !important;*/
            }
            .stepwizard .btn.disabled, .stepwizard .btn[disabled], .stepwizard fieldset[disabled] .btn {
                opacity:1 !important;
                color:#bbb;
            }
            .stepwizard-row:before {
                top: 14px;
                bottom: 0;
                position: absolute;
                content:" ";
                width: 100%;
                height: 1px;
                background-color: #ccc;
                z-index: 0;
            }
            .stepwizard-step {
                display: table-cell;
                text-align: center;
                position: relative;
            }
            .btn-circle {
                width: 30px;
                height: 30px;
                text-align: center;
                padding: 6px 0;
                font-size: 12px;
                line-height: 1.428571429;
                border-radius: 15px;
            }

            .border-choice{
                border: 2px solid black !important;
            }

        </style>  
{% endblock %}

{% block body %}

<div class="container-fluid">

    <div class="row">
       <div class="col-12">
            <div class="row">
                <div class="col-12">
                   <div class="row">
                     <div class="col-lg-6 col-md-6 p-2">
                        <span>FUNERAIRE FRANCE</span>
                     </div>

                     <div class="col-lg-6 col-md-6 p-2">
                        <div class="row">
                            <div class="col-4">
                                <div>
                                    <img class="img-fluid" src="/images/picto-cart.png">
                                </div>
                                <div>
                                </div>
                            </div>
                            <div class="col-4"><img class="img-fluid" src="/images/pct-connexion-bleu.png"></div>
                            <div class="col-4"><img class="img-fluid" src="/images/pct-paiement.png"></div>
                        </div>
                     </div>
                   </div>
                </div>
                <div class="col-lg-7 col-md-7 ml-auto mr-auto">
                    <div class="row">
                        <div class="col-12 border-bottom pb-3 pt-3 pl-3">
                          <span class="h4">Connexion<span>
                        </div>
                        <div class="col-12 pb-3 pt-3 pl-3">
                            <div class="row">
                               <ul class="nav nav-tabs">
                                    <li class="nav-item">
                                        <a class="nav-link conn-tab active" href="#connexion-block">J'ai un compte Funeraire France, Je me connecte</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link conn-tab" href="#registration-block">Je n'ai pas de compte, J'en crée un</a>
                                    </li>
                                </ul>
                            </div>
                            <div id="connexion-block" class="row conn-block mt-3">
                                <div class="col-12">
                                    <form action="{{url('app_login')}}" method="POST">
                                        <div class="input-group form-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-user"></i></span>
                                            </div>
                                            <input type="email" value="" name="email" id="inputEmail" class="form-control" required autofocus>
                                            
                                        </div>
                                        <div class="input-group form-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                            </div>
                                            <input type="password" name="password" id="inputPassword" class="form-control" required>
                                        </div>
                                        <input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}">
                                        <div class="form-group">
                                            <input type="submit" value="Se connecter" class="btn float-right login_btn action-primary">
                                        </div>
                                    </form>
                                </div>

                            </div>
                            <div id="registration-block" class="row conn-block mt-3">
                                <div class="col-lg-8 col-md-10 col-sm-12 col-xs-12 p-2 ml-auto mr-auto"> 
                                        <form class="row" method="POST" action="{{url('app_register')}}">
                                            {{ form_widget(registrationForm._token, {attr: {'class' : 'form-control', 'name' : '_token'}}) }}
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.name, 'Nom') }}
                                                {{ form_widget(registrationForm.name, {attr: {'class' : 'form-control', 'name' : 'name'}}) }}
                                            </div>
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.firstName, 'Prénoms') }}
                                                {{ form_widget(registrationForm.firstName, {attr: {'class' : 'form-control', 'name' : 'firstName'}}) }}
                                            </div>
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.email, 'Email') }}
                                                {{ form_widget(registrationForm.email, {attr: {'class' : 'form-control', 'name' : 'email'}}) }}
                                            </div>
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.phone, 'Numéro de téléphone') }}
                                                {{ form_widget(registrationForm.phone, {attr: {'class' : 'form-control', 'name' : 'phone'}}) }}
                                            </div>
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.address, 'Adresse') }}
                                                {{ form_widget(registrationForm.address, {attr: {'class' : 'form-control', 'name' : 'address'}}) }}
                                            </div>
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.birthday, 'Date de maissance') }}
                                                {{ form_widget(registrationForm.birthday, {attr: {'class' : '', 'name' : 'birthday'}}) }}
                                            </div>
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.type, 'Type de compte') }}
                                                {{ form_widget(registrationForm.type, {attr: {'class' : 'form-control', 'name' : 'type'}}) }}
                                            </div>
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.siret, 'SIRET') }}
                                                {{ form_widget(registrationForm.siret, {attr: {'class' : 'form-control', 'name' : 'siret'}}) }}
                                            </div>
                                            <div class="col-12 form-group">
                                                {{ form_label(registrationForm.company, "Nom de l'entreprise") }}
                                                {{ form_widget(registrationForm.company, {attr: {'class' : 'form-control', 'name' : 'company'}}) }}
                                            </div>
                                            <div class="col-lg-12 form-group">
                                                {{ form_label(registrationForm.plainPassword, 'Mot de passe') }}
                                                {{ form_widget(registrationForm.plainPassword, {attr: {'class' : 'form-control', 'name' : 'password'}}) }}
                                            </div>
                                            {#<div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.firstName, 'Prénoms') }}
                                                {{ form_widget(registrationForm.firstName, {attr: {'class' : 'form-control'}}) }}
                                            </div>
                                            <div class="col-lg-6 form-group">
                                                {{ form_label(registrationForm.firstName, 'Prénoms') }}
                                                {{ form_widget(registrationForm.firstName, {attr: {'class' : 'form-control'}}) }}
                                            </div>#}

                                            <div class="col-lg-12 form-group">
                                                {{ form_widget(registrationForm.agreeTerms) }} 
                                            </div> 
                                            
                                            
                                            <div class="col-lg-12 form-group">
                                                <button type="submit" class="btn action-primary">Créer un compte</button>
                                            </div>

                                                
                                        </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 ml-auto mr-auto">
                    <div class="row">
                        <div class="col-12 border-bottom pb-3 pt-3 pl-3">
                          <span class="h4">Resumé<span>
                        </div>
                        <div class="col-12 pb-3 pt-3">
                            <div class="row border bg-light p-2">
                                 {% set pricing = price_cart(cart, app.user) %}
                                {% set cart_price = pricing.total %}
                                {% set cart_priceHT = pricing.totalHT %}
                                {% set shipping_price = pricing.shipping %}
                                
                                {% for i, order in cart.orders %}
                                    {% if order.productId.subCatId.customizableBeforeOrder %}

                                         {% set meta = decode_meta(order.metaData) %}
                                        
                                        {% for obj in meta.objects %}
                                            {% if obj.frfuNameObject == 'granit' %}
                                                <div class="{{'col-12 border bg-light cart-order order-'~order.productId.id~'-'~order.id}}">
                                                    <div class="row">
                                                        <div class="col-10 d-flex">
                                                            <div class="w-50">
                                                                <img class="img-fluid" src="{{'/'~link_image(order.productId.photo)}}">
                                                            </div> 
                                                            <div>
                                                                <div class="">
                                                                    {{order.productId.name}}
                                                                </div>
                                                                <div class="text-muted">
                                                                    {{order.gallery.granit.name}}
                                                                </div> 
                                                                <div>
                                                                    {% set max = order.productId.stock - order.productId.sale %}
                                                                <span class="text-secondary">Quantité</span> <input min="1" max="{{max}}" style="width: 40px;" id="{{'qty-'~order.productId.id~'-'~order.id}}" type="number" name="{{'qty-'~order.productId.id~'-'~order.id}}" value="{{order.qty}}"> <a href="{{url('cart-update-qty', {'idOrder' : order.id, 'number' : order.qty})}}" class="btn text-success qty-update" data-target="{{'#qty-'~order.productId.id~'-'~order.id}}"><i class="fas fa-check"></i></a> <a href="{{url('cart-order-remove', {'idOrder' : order.id})}}" class="btn text-danger order-remove" data-target="{{'.order-'~order.productId.id~'-'~order.id}}"><i class="fas fa-trash"></i></a>
                                                                </div>
                                                            </div>  
                                                        </div>
                                                        <div class="col-2">
                                                            <div>
                                                                <span>{{obj.dataprice~' €'}}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    </div>
                                            {% else %}
                                                <div class="{{'col-12 border cart-order bg-light order-'~order.productId.id~'-'~order.id}}">
                                                    <div class="row">
                                                            <div class="col-10 d-flex">
                                                                <div class="w-50">
                                                                    <img class="img-fluid" src="{{'/'~link_image(order.productId.photo)}}">
                                                                </div> 
                                                                <div>
                                                                    <div>
                                                                        {{obj.frfuLabelObject}}
                                                                    </div>
                                                                    <div class="text-muted">
                                                                        {% if obj.frfuNameObject == 'fixation' %}

                                                                            <div>
                                                                                {{order.fixation.name}}
                                                                            </div>
                                                                        {% endif %}
                                                                    </div>
                                                                </div>  
                                                            </div>
                                                            <div class="col-2">
                                                                <div>
                                                                    <span>{{obj.dataprice~' €'}}</span>
                                                                </div>
                                                            </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        
                                        <div class="{{'col-12 border bg-light cart-order order-'~order.productId.id~'-'~order.id}}">
                                        <div class="row">
                                                <div class="col-10 d-flex">
                                                    <div class="w-50">
                                                        <img class="img-fluid" src="{{'/'~link_image(order.productId.photo)}}">
                                                    </div> 
                                                    <div>
                                                        <div class="">
                                                            {{order.productId.name}}
                                                        </div>
                                                        <div class="text-muted">
                                                            {{order.productId.matiere}}
                                                        </div> 
                                                        <div>
                                                            {% set max = order.productId.stock - order.productId.sale %}
                                                        <span class="text-secondary">Quantité</span> <input min="1" max="{{max}}" style="width: 40px;" id="{{'qty-'~order.productId.id~'-'~order.id}}" type="number" name="{{'qty-'~order.productId.id~'-'~order.id}}" value="{{order.qty}}"> <a href="{{url('cart-update-qty', {'idOrder' : order.id, 'number' : order.qty})}}" class="btn text-success qty-update" data-target="{{'#qty-'~order.productId.id~'-'~order.id}}"><i class="fas fa-check"></i></a> <a href="{{url('cart-order-remove', {'idOrder' : order.id})}}" class="btn text-danger order-remove" data-target="{{'.order-'~order.productId.id~'-'~order.id}}"><i class="fas fa-trash"></i></a>
                                                        </div>
                                                    </div>  
                                                </div>
                                                <div class="col-2">
                                                    {% set price = order.productId.cprice * order.qty %}
                                                    {% if app.user %}

                                                        {% if app.user.type %}

                                                            {% if app.user.type.id == 2 %}
                                                                {% set price = order.productId.pricepro * order.qty %}
                                                            {% endif %}

                                                        {% endif %}
                                                            
                                                    {% endif %}
                                                    <div>
                                                        <span>{{price~' €'}}</span>
                                                    </div>
                                                </div>
                                        </div>
                                        </div>
                                        {% if order.productId.numberTextCustomize > 0 %}
                                            {% set meta = decode_meta(order.metaData) %}
                                            {% for cus in meta.cus %}
                                                <div class="{{'col-12 border cart-order bg-light order-'~order.productId.id~'-'~order.id}}">
                                                <div class="row">
                                                        <div class="col-10 d-flex">
                                                            <div class="w-50">
                                                                <img class="img-fluid" src="{{'/'~link_image(order.productId.photo)}}">
                                                            </div> 
                                                            <div>
                                                                <div class="">
                                                                    Texte Personnalisée
                                                                </div>
                                                                <div class="text-muted">
                                                                    {{cus}}
                                                                </div> 
                                                            {# <div>
                                                                <span class="text-secondary">Quantité</span> <input style="width: 40px;" id="{{'qty-'~order.productId.id~'-'~order.id}}" type="number" name="{{'qty-'~order.productId.id~'-'~order.id}}"> <a class="btn text-success qty-update" data-target="{{'qty-'~order.productId.id~'-'~order.id}}"><i class="fas fa-check"></i></a> <a class="btn text-danger order-remove" data-target="{{'qty-'~order.productId.id~'-'~order.id}}"><i class="fas fa-trash"></i></a>
                                                                </div>#}
                                                            </div>  
                                                        </div>
                                                        <div class="col-2">
                                                            <div>
                                                                <span>25 €</span>
                                                            </div>
                                                        </div>
                                                </div>
                                                </div>
                                            {% endfor %}

                                            {% for tOrder in meta.tOrder %}
                                                
                                                <div class="{{'col-12 border cart-order bg-light order-'~order.productId.id~'-'~order.id}}">
                                                <div class="row">
                                                        <div class="col-10 d-flex">
                                                            <div class="w-50">
                                                                <img class="img-fluid" src="{{'/'~link_image(order.productId.photo)}}">
                                                            </div> 
                                                            <div>
                                                                <div class="">
                                                                    Texte à visser
                                                                </div>
                                                                <div class="text-muted">
                                                                    {{load_by_id("App\\Entity\\TextOrder", tOrder).content}}
                                                                </div> 
                                                            {# <div>
                                                                <span class="text-secondary">Quantité</span> <input style="width: 40px;" id="{{'qty-'~order.productId.id~'-'~order.id}}" type="number" name="{{'qty-'~order.productId.id~'-'~order.id}}"> <a class="btn text-success qty-update" data-target="{{'qty-'~order.productId.id~'-'~order.id}}"><i class="fas fa-check"></i></a> <a class="btn text-danger order-remove" data-target="{{'qty-'~order.productId.id~'-'~order.id}}"><i class="fas fa-trash"></i></a>
                                                                </div>#}
                                                            </div>  
                                                        </div>
                                                        <div class="col-2">
                                                            <div>
                                                                <span>Offerte</span>
                                                            </div>
                                                        </div>
                                                </div>
                                                </div>
                                            {% endfor %}
                                        {% endif %}

                                    {% endif %}
                                {% endfor %}
                                {% set label = '(TTC)' %}
                                {% set isPro = false %}
                                {% if app.user %}
                                    {% if app.user.type %}
                                        {% if app.user.type.id == 2 %}
                                            {% set label = '(HT)' %}
                                            {% set isPro = true %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                <div class="col-12 pb-3 pt-3">
                                    <div class="row border bg-light p-2">
                                        <div class="col-12 border-bottom">
                                            <div class="d-flex justify-content-start">
                                                <span>Panier {{label}}</span>
                                            </div>
                                            <div class="d-flex justify-content-end">
                                                <span class="h4">{{isPro ? cart_priceHT : cart_price}} €</span>
                                            </div>
                                        </div>
                                        <div class="col-12 border-bottom">
                                            <div class="d-flex justify-content-start">
                                                <span>Livraison</span>
                                            </div>
                                            <div class="d-flex justify-content-end">
                                                <span class="h4">{{shipping_price}} €</span>
                                            </div>
                                        </div>
                                        <div class="col-12 mb-2">
                                            <div class="d-flex justify-content-start">
                                                <span>Total(TTC)</span>
                                            </div>
                                            <div class="d-flex justify-content-end">
                                                <span class="h4">{{cart_price + shipping_price}} €</span>
                                            </div>
                                        </div>
                                        <div class="col-12 p-2 d-flex justify-content-center">
                                                <a class="btn action-primary" href="{{app.user ? url('checkout-cart') : url('checkout-cart-auth-user')}}">Commander <i class="fas fa-shopping-cart"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
          </div>
       </div>
    </div>

</div>

{% endblock %}

{% block javascripts %}

    <script>
        $(function(){
            
           $('.conn-tab').click(function(e){
                e.preventDefault();
                var tab = $(this).attr('href');
                $('.conn-block').hide();
                $(tab).show();
           });

           function typeSelected($value){
            if($value == '2'){
                $('#registration_form_company').parent().show();
                $('#registration_form_siret').parent().show();
            }else{
                $('#registration_form_company').parent().hide();
                $('#registration_form_siret').parent().hide();
            }
        }

        $('#registration_form_type').change(function(){
            $value = $(this).val();
            typeSelected($value);
            console.log($value);
        });

        

       
    

           /*$('.order-remove').click(function(e){
               e.preventDefault();
                var url = $(this).attr('href');
                var orderToRemove = $(this).attr('data-target');
                $.ajax({
                    url: url,
                    type: 'get',
                    success: function(response){
                        console.log(response);
                        $(orderToRemove).remove();
                        $.notify('Commande annulée avec succès', {className: 'bg-success'});
                    },
                    error: function(error){
                        console.log(error);
                        $.notify('Echec d\'annulation de commande', {className: 'bg-danger'});
                    }
                });
           });

           $('#cart-remove').click(function(e){
               e.preventDefault();
                var url = $(this).attr('href');
                var bouton = $(this);
                $.ajax({
                    url: url,
                    type: 'get',
                    success: function(response){
                        console.log(response);
                        $('.cart-order').remove();
                        bouton.remove();
                        $.notify('Le panier a été vidé et toutes les commandes ont été annulées', {className: 'bg-success'});
                    },
                    error: function(error){
                        console.log(error);
                        $.notify('Echec d\'annulation des commandes', {className: 'bg-danger'});
                    }
                });
           });*/

           
           $('.conn-block').hide();
           $($('.conn-tab')[0]).trigger('click');
           $('#registration_form_type').trigger('change');
           
       });
    </script>
        
{% endblock %}